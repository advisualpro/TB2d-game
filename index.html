<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>NUTFALL ‚Äî Demo Level</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{width:100%;height:100%;overflow:hidden;background:#0b1a0b;font-family:'SF Pro Display','Segoe UI',system-ui,-apple-system,sans-serif}
canvas{display:block;position:fixed;top:0;left:0;z-index:1;touch-action:none}

/* ‚îÄ‚îÄ overlays ‚îÄ‚îÄ */
.ov{position:fixed;top:0;left:0;width:100%;height:100%;z-index:40;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:auto}
#scr-start{background:linear-gradient(160deg,#0a1e0a,#143a1a 40%,#1e5428 80%,#0a1e0a)}
#scr-win{background:rgba(10,40,10,.95);display:none}
#scr-lose{background:rgba(50,12,12,.95);display:none}

.logo{font-size:clamp(42px,10vw,72px);margin-bottom:2px}
.ttl{font-size:clamp(28px,7vw,50px);font-weight:900;color:#ffd54f;text-shadow:0 0 60px rgba(255,213,79,.35),0 4px 16px rgba(0,0,0,.6);text-align:center;letter-spacing:-1px}
.ttl2{font-size:clamp(22px,5vw,36px);font-weight:800;text-align:center}
.ttl-g{color:#66bb6a}.ttl-r{color:#ef5350}
.desc{font-size:clamp(12px,3vw,16px);color:rgba(255,255,255,.55);text-align:center;padding:0 28px;line-height:1.55;margin:10px 0 28px;max-width:420px}
.b{min-width:200px;padding:14px 32px;border:none;border-radius:18px;font-size:clamp(15px,4vw,20px);font-weight:800;cursor:pointer;letter-spacing:.3px;margin:6px;transition:transform .12s,box-shadow .12s;pointer-events:auto;position:relative;z-index:41;text-transform:uppercase}
.b:active{transform:scale(.93)}
.b1{background:linear-gradient(135deg,#66bb6a,#2e7d32);color:#fff;box-shadow:0 8px 32px rgba(46,125,50,.45)}
.b2{background:linear-gradient(135deg,#ef5350,#b71c1c);color:#fff;box-shadow:0 8px 24px rgba(183,28,28,.35)}
.b3{background:rgba(255,255,255,.08);color:rgba(255,255,255,.7);border:2px solid rgba(255,255,255,.12)}
.stars{font-size:clamp(32px,9vw,54px);margin:8px 0;letter-spacing:4px}
.stat{color:rgba(255,255,255,.6);font-size:14px}

/* ‚îÄ‚îÄ HUD ‚îÄ‚îÄ */
#hud{position:fixed;top:0;left:0;width:100%;z-index:20;display:none;padding:10px 14px;pointer-events:none}
#hud-top{display:flex;justify-content:space-between;align-items:center}
.pill{background:rgba(0,0,0,.55);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-radius:22px;padding:6px 16px;color:#fff;font-size:13px;font-weight:700;display:flex;align-items:center;gap:5px;border:1px solid rgba(255,255,255,.06)}
.pill i{font-style:normal;font-size:16px}
#timer-wrap{width:100%;height:5px;background:rgba(255,255,255,.07);border-radius:3px;margin-top:8px;overflow:hidden}
#timer-bar{height:100%;border-radius:3px;transition:width .25s linear}

/* ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ */
#toolbar{position:fixed;bottom:0;left:0;width:100%;z-index:20;display:none}
#tbar-inner{display:flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px 14px;background:rgba(0,0,0,.7);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);border-top:1px solid rgba(255,255,255,.06);overflow-x:auto;-webkit-overflow-scrolling:touch;pointer-events:auto}
.tb{min-width:54px;height:58px;border-radius:16px;border:2px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:#fff;font-size:10px;font-weight:700;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;flex-shrink:0;transition:all .15s;pointer-events:auto}
.tb em{font-style:normal;font-size:22px}
.tb small{font-size:9px;opacity:.5}
.tb:active{transform:scale(.88)}
.tb.sel{border-color:#ffd54f;background:rgba(255,213,79,.12);box-shadow:0 0 16px rgba(255,213,79,.15)}
.tb.dis{opacity:.25;pointer-events:none}
#go{min-width:66px;background:linear-gradient(135deg,#66bb6a,#2e7d32)!important;border-color:rgba(255,255,255,.2)!important;box-shadow:0 4px 20px rgba(46,125,50,.4);font-size:12px}

/* ‚îÄ‚îÄ TUTORIAL ‚îÄ‚îÄ */
#tut{position:fixed;bottom:88px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.82);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);color:#fff;padding:12px 22px;border-radius:16px;font-size:13px;font-weight:600;z-index:25;display:none;text-align:center;max-width:92%;line-height:1.45;pointer-events:none;border:1px solid rgba(255,255,255,.06)}
</style>
</head>
<body>
<canvas id="c"></canvas>

<div id="hud">
 <div id="hud-top">
  <div class="pill"><i>üêøÔ∏è</i><span id="h-al">8</span> –∂–∏–≤—ã</div>
  <div class="pill"><i>‚è±</i><span id="h-tm">30</span>—Å</div>
  <div class="pill"><i>üå∞</i><span id="h-sv">0</span> / <span id="h-nd">5</span></div>
 </div>
 <div id="timer-wrap"><div id="timer-bar"></div></div>
</div>

<div id="toolbar"><div id="tbar-inner"></div></div>
<div id="tut"></div>

<!-- START -->
<div class="ov" id="scr-start">
 <div class="logo">üêøÔ∏è</div>
 <div class="ttl">NUTFALL</div>
 <div class="desc">–ü–æ—Å—Ç—Ä–æ–π –ø—É—Ç—å –¥–ª—è –±–µ–ª–æ–∫ –∫ –∑–æ–ª–æ—Ç–æ–º—É –æ—Ä–µ—Ö—É.<br>–†–∞–∑–º–µ—â–∞–π –ø—Ä–µ–¥–º–µ—Ç—ã, –ø–æ—Ç–æ–º –∂–º–∏ –ü–£–°–ö ‚Äî –∏ —Å–º–æ—Ç—Ä–∏, –∫–∞–∫ –æ–Ω–∏ –±–µ–≥—É—Ç!<br><br>–¢–∞–ø ‚Äî –ø–æ—Å—Ç–∞–≤–∏—Ç—å ¬∑ –¢–∞–ø –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É ‚Äî —É–±—Ä–∞—Ç—å<br>‚Ü∫ ‚Üª ‚Äî –ø–æ–≤–µ—Ä–Ω—É—Ç—å –¥–æ—Å–∫—É</div>
 <button class="b b1" id="btn-go">–ù–ê–ß–ê–¢–¨</button>
</div>

<!-- WIN -->
<div class="ov" id="scr-win">
 <div class="logo">üéâ</div>
 <div class="ttl2 ttl-g">–û–¢–õ–ò–ß–ù–û!</div>
 <div class="stars" id="w-st"></div>
 <div class="stat" id="w-tx"></div>
 <button class="b b1" id="btn-again" style="margin-top:20px">–ï–©–Å –†–ê–ó</button>
</div>

<!-- LOSE -->
<div class="ov" id="scr-lose">
 <div class="logo">üíÄ</div>
 <div class="ttl2 ttl-r">–ù–ï –•–í–ê–¢–ò–õ–û</div>
 <div class="desc" id="l-tx"></div>
 <button class="b b2" id="btn-retry">–ó–ê–ù–û–í–û</button>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NUTFALL ‚Äî One polished demo level
   Canvas 2D, physics puzzle, no dependencies
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

const $ = id => document.getElementById(id);
const C = $('c'), X = C.getContext('2d');
let W, H, S; // S = scale factor (px per world unit; world is 800√ó400)

function resize() {
  W = innerWidth; H = innerHeight;
  const dpr = Math.min(devicePixelRatio || 1, 2);
  C.width = W * dpr; C.height = H * dpr;
  C.style.width = W + 'px'; C.style.height = H + 'px';
  X.setTransform(dpr, 0, 0, dpr, 0, 0);
  S = W / 800;          // horizontal scale
}
addEventListener('resize', resize); resize();

// world Y ‚Üí screen Y (keeps aspect ratio with letterboxing)
function wy(v) { return v * H / 400; }
function wx(v) { return v * S; }
function s2w(sx, sy) { return { x: sx / S, y: sy / (H / 400) }; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EASING & DRAWING UTILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function lerp(a, b, t) { return a + (b - a) * t; }
function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }
function rr(x, y, w, h, r) {
  X.beginPath(); X.moveTo(x + r, y);
  X.lineTo(x + w - r, y); X.quadraticCurveTo(x + w, y, x + w, y + r);
  X.lineTo(x + w, y + h - r); X.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  X.lineTo(x + r, y + h); X.quadraticCurveTo(x, y + h, x, y + h - r);
  X.lineTo(x, y + r); X.quadraticCurveTo(x, y, x + r, y); X.closePath();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIMPLE PHYSICS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const GRAV = 0.38;

class Rect {
  constructor(x, y, w, h, o = {}) {
    this.cx = x; this.cy = y; this.hw = w / 2; this.hh = h / 2;
    this.a = o.angle || 0;
    this.vx = 0; this.vy = 0;
    this.stat = o.stat !== false;
    this.bounce = o.bounce || 0.25;
    this.fric = o.fric || 0.92;
    this.label = o.label || '';
    this.bouncy = !!o.bouncy;
    this.dead = false;
    this.cos = Math.cos(this.a); this.sin = Math.sin(this.a);
  }
  aabb() {
    const e = this.hw * Math.abs(this.cos) + this.hh * Math.abs(this.sin);
    const f = this.hw * Math.abs(this.sin) + this.hh * Math.abs(this.cos);
    return { x1: this.cx - e, x2: this.cx + e, y1: this.cy - f, y2: this.cy + f };
  }
}

// Circle vs AABB of rotated rect ‚Üí push-out + normal
function circRect(cx, cy, cr, r) {
  // transform circle into rect local space
  const dx = cx - r.cx, dy = cy - r.cy;
  const lx = dx * r.cos + dy * r.sin;
  const ly = -dx * r.sin + dy * r.cos;
  const clx = clamp(lx, -r.hw, r.hw);
  const cly = clamp(ly, -r.hh, r.hh);
  const ex = lx - clx, ey = ly - cly;
  const d2 = ex * ex + ey * ey;
  if (d2 >= cr * cr) return null;
  const d = Math.sqrt(d2) || 0.001;
  const pen = cr - d;
  // normal in local
  const nlx = ex / d, nly = ey / d;
  // back to world
  const wnx = nlx * r.cos - nly * r.sin;
  const wny = nlx * r.sin + nly * r.cos;
  return { pen, nx: wnx, ny: wny };
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WORLD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let bodies = [], squirrels = [], particles = [], tick = 0;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SQUIRREL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
class Sq {
  constructor(x, y, del) {
    this.x = x; this.y = y; this.vx = 0; this.vy = 0; this.r = 9;
    this.alive = true; this.saved = false; this.ground = false;
    this.del = del; this.on = false;
    this.dir = 1; this.spd = 1.05 + Math.random() * 0.45;
    this.hue = 25 + Math.random() * 25 | 0;
    this.sat = 72 + Math.random() * 18 | 0;
    this.lit = 48 + Math.random() * 16 | 0;
    this.tail = Math.random() * 6.28;
    this.blink = 100 + Math.random() * 140 | 0;
    this.jcd = 0; this.stk = 0; this.lx = x; this.at = 0; this.dt = 80;
  }
  get col() { return `hsl(${this.hue},${this.sat}%,${this.lit}%)`; }
  get colL() { return `hsl(${this.hue},${this.sat}%,${this.lit + 18}%)`; }
  get colD() { return `hsl(${this.hue},${this.sat}%,${this.lit - 14}%)`; }
}

function spawnPart(x, y, col, n = 8, sp = 3.5) {
  for (let i = 0; i < n; i++) {
    const a = Math.random() * 6.28, v = 0.8 + Math.random() * sp;
    particles.push({ x, y, vx: Math.cos(a) * v, vy: Math.sin(a) * v - 1.8,
      life: 28 + Math.random() * 28 | 0, ml: 56, r: 1.5 + Math.random() * 3, col });
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEVEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const LEVEL = {
  squirrels: 8, need: 5, time: 35,
  spawn: { x: 65, y: 248 },
  goal: { x: 700, y: 290 },
  platforms: [
    { x: 0,   y: 310, w: 220, h: 28 },      // left ground
    { x: 310, y: 265, w: 90,  h: 14 },       // mid floating
    { x: 520, y: 310, w: 280, h: 28 },       // right ground
  ],
  hazards: [
    { x: 220, y: 332, w: 90,  h: 24, t: 'water' },
    { x: 420, y: 332, w: 100, h: 24, t: 'water' },
    { x: 400, y: 294, w: 34,  h: 16, t: 'spike' },
  ],
  tools: { plank: 3, box: 3, trampoline: 1 }
};

const ITEMS = {
  plank:      { n: '–î–æ—Å–∫–∞',  ic: 'üìè', w: 80, h: 9,  rot: true },
  box:        { n: '–Ø—â–∏–∫',   ic: 'üì¶', w: 26, h: 26, rot: false },
  trampoline: { n: '–ë–∞—Ç—É—Ç',  ic: 'üíé', w: 48, h: 7,  rot: false, bouncy: true },
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let G = {
  ph: 'start',         // start | plan | run | win | lose
  placed: [],           // { type, x, y, a }
  sel: null,            // selected tool key
  ga: 0,                // ghost angle
  pt: 0,                // plan timer
  saved: 0,
  tb: {},               // remaining toolbox counts
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function init() {
  G.ph = 'plan'; G.saved = 0; G.sel = null; G.ga = 0;
  G.placed = []; tick = 0;
  bodies = []; squirrels = []; particles = [];
  G.pt = LEVEL.time;
  G.tb = {}; for (let k in LEVEL.tools) G.tb[k] = LEVEL.tools[k];

  LEVEL.platforms.forEach(p =>
    bodies.push(new Rect(p.x + p.w / 2, p.y + p.h / 2, p.w, p.h, { label: 'plat' }))
  );
  // floor + walls
  bodies.push(new Rect(400, 398, 860, 24, { label: 'floor' }));
  bodies.push(new Rect(-12, 200, 24, 440, { label: 'wall' }));
  bodies.push(new Rect(812, 200, 24, 440, { label: 'wall' }));

  hide('scr-start'); hide('scr-win'); hide('scr-lose');
  $('hud').style.display = 'block';
  buildTB(); updHUD();
  showTut('–í—ã–±–µ—Ä–∏ –ø—Ä–µ–¥–º–µ—Ç ‚Üí —Ç–∞–ø–Ω–∏ –Ω–∞ –ø–æ–ª–µ ‚Äî –ø–æ—Å—Ç–∞–≤–∏—Ç—å\n–¢–∞–ø–Ω–∏ –Ω–∞ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π ‚Äî —É–±—Ä–∞—Ç—å ¬∑ ‚Ü∫‚Üª –≤—Ä–∞—â–µ–Ω–∏–µ\n–ó–∞—Ç–µ–º –Ω–∞–∂–º–∏ ‚ñ∂ –ü–£–°–ö');
}

function run() {
  G.ph = 'run'; G.sel = null; hideTut();
  // materialize placed items
  G.placed.forEach(it => {
    const d = ITEMS[it.type];
    bodies.push(new Rect(it.x, it.y, d.w, d.h,
      { label: 'p_' + it.type, angle: it.a, bouncy: !!d.bouncy }));
  });
  // spawn squirrels
  for (let i = 0; i < LEVEL.squirrels; i++)
    squirrels.push(new Sq(LEVEL.spawn.x, LEVEL.spawn.y, i * 20));
  buildTB();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SQUIRREL UPDATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updSq(sq) {
  if (!sq.alive || sq.saved || !sq.on) return;
  const gx = LEVEL.goal.x;
  sq.vy += GRAV;
  sq.dir = gx > sq.x ? 1 : -1;
  if (sq.ground) sq.vx = sq.dir * sq.spd;

  sq.at++;
  if (sq.at % 22 === 0) {
    if (Math.abs(sq.x - sq.lx) < 1.2 && sq.ground) {
      sq.stk++;
      if (sq.stk > 2 && sq.jcd <= 0) {
        sq.vy = -7.8 - Math.random() * 2.2;
        sq.vx = sq.dir * (2.8 + Math.random() * 1.5);
        sq.ground = false; sq.jcd = 32; sq.stk = 0;
      }
    } else sq.stk = 0;
    sq.lx = sq.x;
  }
  if (sq.jcd > 0) sq.jcd--;

  sq.x += sq.vx; sq.y += sq.vy;
  sq.vx *= 0.985;
  sq.tail += 0.16;
  sq.blink--; if (sq.blink <= 0) sq.blink = 110 + Math.random() * 130 | 0;

  // collisions
  sq.ground = false;
  for (const b of bodies) {
    if (b.dead) continue;
    const c = circRect(sq.x, sq.y, sq.r, b);
    if (!c) continue;
    sq.x += c.nx * c.pen; sq.y += c.ny * c.pen;
    if (c.ny < -0.45) {
      sq.ground = true; sq.vy = 0;
      if (b.bouncy) {
        sq.vy = -11.5 - Math.random() * 1.5;
        sq.ground = false;
        spawnPart(sq.x, sq.y + sq.r, '#4fc3f7', 6, 2.5);
      }
    } else {
      const dot = sq.vx * c.nx + sq.vy * c.ny;
      sq.vx -= dot * c.nx * 0.55;
      sq.vy -= dot * c.ny * 0.55;
    }
  }

  // hazards
  for (const hz of LEVEL.hazards)
    if (sq.x + sq.r > hz.x && sq.x - sq.r < hz.x + hz.w &&
        sq.y + sq.r > hz.y && sq.y - sq.r < hz.y + hz.h) killSq(sq);

  // goal
  if (Math.abs(sq.x - LEVEL.goal.x) < 26 && Math.abs(sq.y - LEVEL.goal.y) < 32) {
    sq.saved = true; G.saved++;
    spawnPart(sq.x, sq.y, '#ffd54f', 18, 5);
    spawnPart(sq.x, sq.y, '#fff', 8, 3);
    updHUD();
  }
  if (sq.y > 410 || sq.x < -30 || sq.x > 830) killSq(sq);
}

function killSq(sq) {
  if (!sq.alive) return;
  sq.alive = false; sq.dt = 70;
  spawnPart(sq.x, sq.y, '#ef5350', 14, 4);
  spawnPart(sq.x, sq.y, sq.col, 10, 3);
  updHUD();
}

function physTick() {
  tick++;
  squirrels.forEach(sq => {
    if (sq.del > 0) { sq.del--; return; }
    if (!sq.on) sq.on = true;
    updSq(sq);
  });
  // end check
  if (G.ph !== 'run') return;
  const alive = squirrels.filter(s => s.alive && !s.saved);
  const wait  = squirrels.filter(s => s.del > 0);
  if (alive.length === 0 && wait.length === 0)
    setTimeout(() => { if (G.ph !== 'run') return; G.saved >= LEVEL.need ? doWin() : doLose(); }, 500);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ‚ïê‚ïê‚ïê RENDERING ‚ïê‚ïê‚ïê ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// ‚îÄ‚îÄ background ‚îÄ‚îÄ
const BG_STARS = Array.from({ length: 80 }, () => ({
  x: Math.random() * 800, y: Math.random() * 400,
  r: 0.4 + Math.random() * 1.1, p: Math.random() * 6.28
}));

function drawBg() {
  // sky gradient ‚Äî rich forest night
  const g = X.createLinearGradient(0, 0, 0, H);
  g.addColorStop(0, '#071412');
  g.addColorStop(0.3, '#0e2818');
  g.addColorStop(0.65, '#173d22');
  g.addColorStop(1, '#0e2818');
  X.fillStyle = g; X.fillRect(0, 0, W, H);

  // subtle radial light behind goal
  const gx = wx(LEVEL.goal.x), gy = wy(LEVEL.goal.y);
  const rg = X.createRadialGradient(gx, gy - 20, 0, gx, gy - 20, W * 0.35);
  rg.addColorStop(0, 'rgba(255,213,79,.06)');
  rg.addColorStop(1, 'rgba(255,213,79,0)');
  X.fillStyle = rg; X.fillRect(0, 0, W, H);

  // stars
  BG_STARS.forEach(s => {
    const sx = wx(s.x), sy2 = wy(s.y);
    const twinkle = 0.45 + 0.45 * Math.sin(tick * 0.02 + s.p);
    X.beginPath(); X.arc(sx, sy2, s.r, 0, 6.28);
    X.fillStyle = `rgba(255,255,255,${twinkle})`; X.fill();
  });

  // distant tree silhouettes
  X.save();
  X.fillStyle = 'rgba(8,30,14,.65)';
  for (let i = 0; i < 14; i++) {
    const tx = i * 62 * S, th = (50 + Math.sin(i * 1.7) * 25) * (H / 400);
    const tb = wy(310);
    X.beginPath();
    X.moveTo(tx, tb);
    X.lineTo(tx + 14 * S, tb - th);
    X.lineTo(tx + 28 * S, tb);
    X.fill();
  }
  X.restore();

  // ground haze
  const hg = X.createLinearGradient(0, wy(340), 0, H);
  hg.addColorStop(0, 'rgba(14,40,24,.0)');
  hg.addColorStop(1, 'rgba(14,40,24,.5)');
  X.fillStyle = hg; X.fillRect(0, wy(340), W, H - wy(340));
}

// ‚îÄ‚îÄ platforms ‚îÄ‚îÄ
function drawPlatform(b) {
  const x1 = wx(b.cx - b.hw), y1 = wy(b.cy - b.hh);
  const pw = wx(b.hw * 2), ph = wy(b.hh * 2);
  const rad = Math.min(6 * S, pw / 4);

  // shadow
  X.save();
  X.shadowColor = 'rgba(0,0,0,.28)';
  X.shadowBlur = 12 * S; X.shadowOffsetY = 4 * S;
  const pg = X.createLinearGradient(x1, y1, x1, y1 + ph);
  pg.addColorStop(0, '#5e9b3c');
  pg.addColorStop(0.4, '#4a8230');
  pg.addColorStop(1, '#3a6924');
  X.fillStyle = pg;
  rr(x1, y1, pw, ph, rad); X.fill();
  X.restore();

  // top grass
  X.fillStyle = '#72b84a';
  rr(x1, y1, pw, Math.max(4 * S, ph * 0.22), rad); X.fill();

  // grass blades
  X.save();
  for (let i = x1 + 3 * S; i < x1 + pw - 2 * S; i += 5 * S) {
    const bh = (3 + Math.sin(i * 0.8 + tick * 0.04) * 1.5) * S;
    X.fillStyle = `rgba(130,200,80,${0.5 + Math.random() * 0.3})`;
    X.fillRect(i, y1 - bh, 2 * S, bh + 1);
  }
  X.restore();

  // top highlight
  const hl = X.createLinearGradient(x1, y1, x1, y1 + 4 * S);
  hl.addColorStop(0, 'rgba(255,255,255,.12)');
  hl.addColorStop(1, 'rgba(255,255,255,0)');
  X.fillStyle = hl;
  rr(x1, y1, pw, 4 * S, rad); X.fill();
}

function drawFloor(b) {
  const x1 = wx(b.cx - b.hw), y1 = wy(b.cy - b.hh);
  const pw = wx(b.hw * 2), ph = wy(b.hh * 2);
  const g = X.createLinearGradient(x1, y1, x1, y1 + ph);
  g.addColorStop(0, '#4a3a22'); g.addColorStop(1, '#2c1e10');
  X.fillStyle = g; X.fillRect(x1, y1, pw, ph);
}

// ‚îÄ‚îÄ placed items during run ‚îÄ‚îÄ
function drawPlaced(b) {
  X.save();
  X.translate(wx(b.cx), wy(b.cy));
  X.rotate(b.a);
  const pw = wx(b.hw * 2), ph = wy(b.hh * 2);

  // shadow
  X.shadowColor = 'rgba(0,0,0,.22)';
  X.shadowBlur = 8 * S; X.shadowOffsetY = 3 * S;

  if (b.label.includes('plank')) {
    const g = X.createLinearGradient(0, -ph / 2, 0, ph / 2);
    g.addColorStop(0, '#dbb36e'); g.addColorStop(0.5, '#c49a52'); g.addColorStop(1, '#a07a38');
    X.fillStyle = g;
    rr(-pw / 2, -ph / 2, pw, ph, 3 * S); X.fill();
    // wood grain
    X.strokeStyle = 'rgba(90,60,20,.12)'; X.lineWidth = 0.7;
    for (let i = -pw / 2 + 7 * S; i < pw / 2; i += 9 * S) {
      X.beginPath(); X.moveTo(i, -ph / 2); X.lineTo(i, ph / 2); X.stroke();
    }
    // highlight
    const hl = X.createLinearGradient(0, -ph / 2, 0, -ph / 2 + 3 * S);
    hl.addColorStop(0, 'rgba(255,255,255,.15)'); hl.addColorStop(1, 'rgba(255,255,255,0)');
    X.fillStyle = hl; rr(-pw / 2, -ph / 2, pw, 3 * S, 3 * S); X.fill();
  } else if (b.label.includes('box')) {
    const g = X.createLinearGradient(-pw / 2, -ph / 2, pw / 2, ph / 2);
    g.addColorStop(0, '#c9a06a'); g.addColorStop(1, '#8a6838');
    X.fillStyle = g;
    rr(-pw / 2, -ph / 2, pw, ph, 4 * S); X.fill();
    // cross
    X.strokeStyle = 'rgba(60,40,10,.12)'; X.lineWidth = 1;
    X.beginPath(); X.moveTo(-pw / 2, -ph / 2); X.lineTo(pw / 2, ph / 2); X.stroke();
    X.beginPath(); X.moveTo(pw / 2, -ph / 2); X.lineTo(-pw / 2, ph / 2); X.stroke();
    // border
    X.strokeStyle = 'rgba(0,0,0,.12)'; X.lineWidth = 1.5;
    rr(-pw / 2, -ph / 2, pw, ph, 4 * S); X.stroke();
  } else if (b.label.includes('trampoline')) {
    // base
    X.fillStyle = '#1a6090';
    rr(-pw / 2, -ph / 2, pw, ph, 3 * S); X.fill();
    // elastic surface
    const tg = X.createLinearGradient(0, -ph / 2, 0, 0);
    tg.addColorStop(0, '#4fc3f7'); tg.addColorStop(1, '#2196f3');
    X.fillStyle = tg;
    rr(-pw / 2, -ph / 2, pw, ph * 0.55, 3 * S); X.fill();
    // shine
    X.fillStyle = 'rgba(255,255,255,.18)';
    rr(-pw / 2 + 4 * S, -ph / 2, pw - 8 * S, 2 * S, 1); X.fill();
    // springs
    X.strokeStyle = 'rgba(255,255,255,.25)'; X.lineWidth = 1;
    for (let i = -pw / 2 + 6 * S; i < pw / 2; i += 7 * S) {
      X.beginPath(); X.moveTo(i, -ph / 2 + 1); X.lineTo(i + 2 * S, ph / 2 - 1); X.stroke();
    }
    // glow
    X.shadowColor = 'rgba(79,195,247,.3)'; X.shadowBlur = 12 * S;
    X.strokeStyle = 'rgba(79,195,247,.2)'; X.lineWidth = 2;
    rr(-pw / 2, -ph / 2, pw, ph, 3 * S); X.stroke();
  }
  X.restore();
}

// ‚îÄ‚îÄ hazards ‚îÄ‚îÄ
function drawHazards() {
  for (const hz of LEVEL.hazards) {
    const hx = wx(hz.x), hy = wy(hz.y), hw2 = wx(hz.w), hh2 = wy(hz.h);
    if (hz.t === 'water') {
      const wg = X.createLinearGradient(hx, hy, hx, hy + hh2);
      wg.addColorStop(0, 'rgba(33,150,243,.15)');
      wg.addColorStop(0.5, 'rgba(33,150,243,.35)');
      wg.addColorStop(1, 'rgba(13,71,161,.55)');
      X.fillStyle = wg; X.fillRect(hx, hy, hw2, hh2);
      // wave line
      X.strokeStyle = 'rgba(100,200,255,.35)'; X.lineWidth = 1.5;
      X.beginPath();
      for (let i = hx; i <= hx + hw2; i += 3 * S)
        X.lineTo(i, hy + Math.sin(tick * 0.055 + i * 0.06) * 2.5 * S);
      X.stroke();
      // second wave
      X.strokeStyle = 'rgba(100,200,255,.18)'; X.lineWidth = 1;
      X.beginPath();
      for (let i = hx; i <= hx + hw2; i += 3 * S)
        X.lineTo(i, hy + 3 * S + Math.sin(tick * 0.04 + i * 0.08 + 1) * 2 * S);
      X.stroke();
      // bubble particles
      if (tick % 18 === 0) spawnPart(hz.x + Math.random() * hz.w, hz.y + hz.h * 0.5, 'rgba(130,210,255,.4)', 1, 0.8);
    } else if (hz.t === 'spike') {
      const step = 7 * S;
      for (let i = hx; i < hx + hw2; i += step) {
        const g = X.createLinearGradient(i, hy + hh2, i, hy);
        g.addColorStop(0, '#888'); g.addColorStop(0.3, '#aaa'); g.addColorStop(1, '#ddd');
        X.fillStyle = g;
        X.beginPath(); X.moveTo(i, hy + hh2); X.lineTo(i + step / 2, hy); X.lineTo(i + step, hy + hh2); X.fill();
      }
      // danger glow
      X.fillStyle = 'rgba(255,50,50,.06)'; X.fillRect(hx, hy - 4 * S, hw2, hh2 + 8 * S);
    }
  }
}

// ‚îÄ‚îÄ goal (golden nut) ‚îÄ‚îÄ
function drawGoal() {
  const gx = wx(LEVEL.goal.x), gy = wy(LEVEL.goal.y);
  const bob = Math.sin(tick * 0.04) * 4 * S;
  const pulse = 1 + Math.sin(tick * 0.06) * 0.05;
  X.save(); X.translate(gx, gy + bob); X.scale(pulse, pulse);

  // outer glow
  const og = X.createRadialGradient(0, -6 * S, 2, 0, -6 * S, 28 * S);
  og.addColorStop(0, 'rgba(255,213,79,.22)');
  og.addColorStop(0.5, 'rgba(255,213,79,.06)');
  og.addColorStop(1, 'rgba(255,213,79,0)');
  X.fillStyle = og; X.beginPath(); X.arc(0, -6 * S, 28 * S, 0, 6.28); X.fill();

  // nut body
  const ng = X.createRadialGradient(-3 * S, -9 * S, 2, 0, -5 * S, 11 * S);
  ng.addColorStop(0, '#ffe082'); ng.addColorStop(0.6, '#ffd54f'); ng.addColorStop(1, '#f9a825');
  X.fillStyle = ng;
  X.beginPath(); X.arc(0, -4 * S, 11 * S, 0, 6.28); X.fill();

  // cap
  const cg = X.createLinearGradient(0, -16 * S, 0, -10 * S);
  cg.addColorStop(0, '#8d6e2f'); cg.addColorStop(1, '#6d4c14');
  X.fillStyle = cg;
  X.beginPath(); X.ellipse(0, -13 * S, 8 * S, 4 * S, 0, 0, Math.PI, true); X.fill();
  X.fillRect(-1.2 * S, -18 * S, 2.4 * S, 5 * S);

  // specular
  X.fillStyle = 'rgba(255,255,255,.35)';
  X.beginPath(); X.ellipse(-3 * S, -8 * S, 3 * S, 4.5 * S, -0.3, 0, 6.28); X.fill();

  X.restore();
}

// ‚îÄ‚îÄ squirrel ‚îÄ‚îÄ
function drawSq(sq) {
  if (sq.saved) return;
  const sx2 = wx(sq.x), sy2 = wy(sq.y), r = sq.r * S;
  if (!sq.alive) {
    sq.dt--; if (sq.dt <= 0) return;
    X.globalAlpha = sq.dt / 70;
    X.beginPath(); X.arc(sx2, sy2, r * 0.35, 0, 6.28); X.fillStyle = '#888'; X.fill();
    X.globalAlpha = 1; return;
  }
  if (!sq.on) {
    const by = Math.sin(tick * 0.09 + sq.spd * 8) * 2 * S;
    X.globalAlpha = 0.35;
    X.beginPath(); X.arc(sx2, sy2 + by, r * 0.45, 0, 6.28); X.fillStyle = sq.col; X.fill();
    X.globalAlpha = 1; return;
  }
  X.save(); X.translate(sx2, sy2);
  const f = sq.dir; X.scale(f, 1);

  // drop shadow
  X.beginPath(); X.ellipse(0, r + 1 * S, r * 0.7, 2.2 * S, 0, 0, 6.28);
  X.fillStyle = 'rgba(0,0,0,.12)'; X.fill();

  // tail
  const tw = Math.sin(sq.tail) * 4 * S;
  X.beginPath(); X.moveTo(-1 * S, -r + 2 * S);
  X.bezierCurveTo(-r * 1.1 - tw, -r * 1.5, -r * 1.3 - tw * 0.5, -r * 2, -r * 0.5, -r * 1.9);
  X.bezierCurveTo(-r * 0.2 + tw * 0.3, -r * 1.5, 1 * S, -r + 3 * S, 1 * S, -r + 3 * S);
  X.fillStyle = sq.colD; X.fill();

  // body
  X.beginPath(); X.arc(0, 0, r, 0, 6.28);
  const bg = X.createRadialGradient(-2 * S, -2 * S, 0, 0, 0, r);
  bg.addColorStop(0, sq.colL); bg.addColorStop(1, sq.col);
  X.fillStyle = bg; X.fill();

  // belly
  X.beginPath(); X.ellipse(1 * S, 2 * S, r * 0.48, r * 0.42, 0.1, 0, 6.28);
  X.fillStyle = `hsl(${sq.hue},${sq.sat - 10}%,${sq.lit + 26}%)`; X.fill();

  // ears
  [[-4.5 * S, -r + 0.5 * S], [4.5 * S, -r + 0.5 * S]].forEach(([ex, ey]) => {
    X.beginPath(); X.ellipse(ex, ey - 3.5 * S, 2.5 * S, 4.5 * S, ex < 0 ? -0.25 : 0.25, 0, 6.28);
    X.fillStyle = sq.col; X.fill();
    X.beginPath(); X.ellipse(ex, ey - 3.5 * S, 1.2 * S, 2.5 * S, ex < 0 ? -0.25 : 0.25, 0, 6.28);
    X.fillStyle = `hsl(${sq.hue + 10},60%,72%)`; X.fill();
  });

  // eyes
  const bl = sq.blink < 5;
  [[-3.2 * S, -1.5 * S], [3.2 * S, -1.5 * S]].forEach(([ex, ey]) => {
    // white
    X.beginPath(); X.ellipse(ex, ey, 2.4 * S, bl ? 0.8 * S : 3.2 * S, 0, 0, 6.28);
    X.fillStyle = '#fff'; X.fill();
    if (!bl) {
      // pupil
      X.beginPath(); X.arc(ex + 0.8 * S, ey, 1.3 * S, 0, 6.28);
      X.fillStyle = '#1a1a1a'; X.fill();
      // highlight
      X.beginPath(); X.arc(ex + 1.2 * S, ey - 0.8 * S, 0.5 * S, 0, 6.28);
      X.fillStyle = '#fff'; X.fill();
    }
  });

  // nose
  X.beginPath(); X.ellipse(0.5 * S, 1 * S, 1.4 * S, 1 * S, 0, 0, 6.28);
  X.fillStyle = '#d44'; X.fill();

  // cheeks
  X.globalAlpha = 0.18;
  X.beginPath(); X.arc(-4.5 * S, 2 * S, 2.5 * S, 0, 6.28);
  X.fillStyle = '#ffab91'; X.fill();
  X.beginPath(); X.arc(4.5 * S, 2 * S, 2.5 * S, 0, 6.28); X.fill();
  X.globalAlpha = 1;

  // feet
  if (sq.ground) {
    const fw = Math.sin(tick * 0.19) * 1.4 * S;
    X.fillStyle = sq.colD;
    X.beginPath(); X.ellipse(-2.5 * S + fw, r + 0.5 * S, 2.5 * S, 1.5 * S, 0, 0, 6.28); X.fill();
    X.beginPath(); X.ellipse(2.5 * S - fw, r + 0.5 * S, 2.5 * S, 1.5 * S, 0, 0, 6.28); X.fill();
  }

  // body highlight
  X.globalAlpha = 0.1;
  X.beginPath(); X.ellipse(-2 * S, -3 * S, r * 0.5, r * 0.35, -0.3, 0, 6.28);
  X.fillStyle = '#fff'; X.fill();
  X.globalAlpha = 1;

  X.restore();
}

// ‚îÄ‚îÄ placed item ghosts (plan phase) ‚îÄ‚îÄ
function drawGhosts() {
  G.placed.forEach(it => {
    const d = ITEMS[it.type];
    const px = wx(it.x), py = wy(it.y);
    const pw = wx(d.w), ph = wy(d.h);
    X.save(); X.translate(px, py); X.rotate(it.a);
    X.globalAlpha = 0.6;

    if (it.type === 'plank') {
      X.fillStyle = '#c49a52';
      rr(-pw / 2, -ph / 2, pw, ph, 3 * S); X.fill();
    } else if (it.type === 'box') {
      X.fillStyle = '#a48050';
      rr(-pw / 2, -ph / 2, pw, ph, 3 * S); X.fill();
    } else if (it.type === 'trampoline') {
      X.fillStyle = '#2196f3';
      rr(-pw / 2, -ph / 2, pw, ph, 3 * S); X.fill();
    }

    // remove icon
    X.globalAlpha = 0.75; X.fillStyle = '#fff';
    X.font = `bold ${10 * S}px sans-serif`; X.textAlign = 'center'; X.textBaseline = 'middle';
    X.fillText('‚úï', 0, 0);
    X.globalAlpha = 1; X.restore();
  });
}

// ‚îÄ‚îÄ cursor ghost ‚îÄ‚îÄ
let mX = W / 2, mY = H / 2;
function drawCursor() {
  if (!G.sel || G.ph !== 'plan') return;
  const d = ITEMS[G.sel]; if (!d) return;
  const pw = wx(d.w), ph = wy(d.h);
  X.save(); X.translate(mX, mY); X.rotate(G.ga);
  X.globalAlpha = 0.3;
  X.fillStyle = d.bouncy ? '#2196f3' : '#c49a52';
  rr(-pw / 2, -ph / 2, pw, ph, 3 * S); X.fill();
  X.globalAlpha = 1; X.restore();
}

// ‚îÄ‚îÄ particles ‚îÄ‚îÄ
function drawParts() {
  particles = particles.filter(p => {
    p.x += p.vx; p.y += p.vy; p.vy += 0.1; p.life--;
    if (p.life <= 0) return false;
    const a = p.life / p.ml;
    X.globalAlpha = a;
    X.beginPath(); X.arc(wx(p.x), wy(p.y), p.r * S * a, 0, 6.28);
    X.fillStyle = p.col; X.fill();
    X.globalAlpha = 1;
    return true;
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PLACEMENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function place(wxx, wyy) {
  if (!G.sel || G.ph !== 'plan' || (G.tb[G.sel] || 0) <= 0) return;
  if (wxx < 8 || wxx > 792 || wyy < 8 || wyy > 385) return;
  G.placed.push({ type: G.sel, x: wxx, y: wyy, a: G.ga });
  G.tb[G.sel]--;
  if (G.tb[G.sel] <= 0) G.sel = null;
  buildTB();
}
function remove(i) {
  if (G.ph !== 'plan') return;
  G.tb[G.placed[i].type] = (G.tb[G.placed[i].type] || 0) + 1;
  G.placed.splice(i, 1); buildTB();
}
function findAt(wxx, wyy) {
  for (let i = G.placed.length - 1; i >= 0; i--) {
    const it = G.placed[i], d = ITEMS[it.type];
    const dx = wxx - it.x, dy = wyy - it.y;
    const c = Math.cos(-it.a), sn = Math.sin(-it.a);
    if (Math.abs(dx * c - dy * sn) < d.w / 2 + 8 && Math.abs(dx * sn + dy * c) < d.h / 2 + 8) return i;
  }
  return -1;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INPUT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
C.addEventListener('pointerdown', e => {
  e.preventDefault();
  const r = C.getBoundingClientRect();
  const sx = e.clientX - r.left, sy = e.clientY - r.top;
  mX = sx; mY = sy;
  if (G.ph === 'plan') {
    const wp = s2w(sx, sy);
    const idx = findAt(wp.x, wp.y);
    if (idx >= 0) { remove(idx); return; }
    if (G.sel) place(wp.x, wp.y);
  }
});
C.addEventListener('pointermove', e => {
  const r = C.getBoundingClientRect(); mX = e.clientX - r.left; mY = e.clientY - r.top;
});
document.addEventListener('keydown', e => {
  if (e.code === 'KeyQ') G.ga -= Math.PI / 12;
  if (e.code === 'KeyE') G.ga += Math.PI / 12;
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function hide(id) { $(id).style.display = 'none'; }
function show(id) { $(id).style.display = 'flex'; }
function showTut(t) { $('tut').textContent = t; $('tut').style.display = 'block'; }
function hideTut() { $('tut').style.display = 'none'; }
function mk(t, c) { const e = document.createElement(t); e.className = c; return e; }

function updHUD() {
  const al = squirrels.filter(s => s.alive && !s.saved).length;
  $('h-al').textContent = al;
  $('h-sv').textContent = G.saved;
  $('h-nd').textContent = LEVEL.need;
  const t = Math.max(0, Math.ceil(G.pt));
  $('h-tm').textContent = t;
  const pct = G.ph === 'plan' ? (G.pt / LEVEL.time * 100) : 0;
  const bar = $('timer-bar');
  bar.style.width = pct + '%';
  bar.style.background = pct > 40 ? 'linear-gradient(90deg,#66bb6a,#aed581)' :
                          pct > 15 ? 'linear-gradient(90deg,#ffd54f,#ffb300)' :
                                     'linear-gradient(90deg,#ef5350,#ff8a65)';
}

function buildTB() {
  const row = $('tbar-inner'); row.innerHTML = '';
  if (G.ph === 'plan') {
    // rotate left
    let rl = mk('button', 'tb'); rl.innerHTML = '<em>‚Ü∫</em>';
    rl.onclick = () => { G.ga -= Math.PI / 8; }; row.appendChild(rl);

    for (let k in G.tb) {
      const d = ITEMS[k], cnt = G.tb[k];
      let btn = mk('button', 'tb' + (G.sel === k ? ' sel' : '') + (cnt <= 0 ? ' dis' : ''));
      btn.innerHTML = `<em>${d.ic}</em><small>${d.n} √ó${cnt}</small>`;
      const key = k;
      btn.onclick = () => { G.sel = G.sel === key ? null : key; G.ga = 0; buildTB(); };
      row.appendChild(btn);
    }

    // rotate right
    let rr2 = mk('button', 'tb'); rr2.innerHTML = '<em>‚Üª</em>';
    rr2.onclick = () => { G.ga += Math.PI / 8; }; row.appendChild(rr2);

    // GO
    let go = mk('button', 'tb'); go.id = 'go';
    go.innerHTML = '<em>‚ñ∂</em>–ü–£–°–ö';
    go.onclick = () => run(); row.appendChild(go);
  } else if (G.ph === 'run') {
    const info = mk('div', '');
    info.style.cssText = 'color:rgba(255,255,255,.45);font-size:13px;padding:14px;font-weight:600';
    info.textContent = 'üêøÔ∏è –ë–µ–ª–∫–∏ –±–µ–≥—É—Ç –∫ –æ—Ä–µ—Ö—É‚Ä¶';
    row.appendChild(info);
  }
  $('toolbar').style.display = 'block';
}

function doWin() {
  G.ph = 'win';
  const ratio = G.saved / LEVEL.squirrels;
  const st = ratio >= 0.85 ? 3 : ratio >= 0.55 ? 2 : 1;
  $('w-st').textContent = '‚≠ê'.repeat(st) + '‚òÜ'.repeat(3 - st);
  $('w-tx').textContent = `–°–ø–∞—Å–µ–Ω–æ: ${G.saved} –∏–∑ ${LEVEL.squirrels}`;
  hide('scr-lose'); $('toolbar').style.display = 'none';
  show('scr-win');
}
function doLose() {
  G.ph = 'lose';
  $('l-tx').textContent = `–°–ø–∞—Å–µ–Ω–æ ${G.saved} –∏–∑ ${LEVEL.need} –Ω—É–∂–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥—É—é —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫—É!`;
  hide('scr-win'); $('toolbar').style.display = 'none';
  show('scr-lose');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BUTTON BINDINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
$('btn-go').addEventListener('click', init);
$('btn-again').addEventListener('click', init);
$('btn-retry').addEventListener('click', init);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN LOOP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let lt = 0;
function loop(ts) {
  const dt = Math.min(ts - lt, 50); lt = ts;
  X.clearRect(0, 0, W, H);

  if (G.ph === 'plan' || G.ph === 'run') {
    drawBg();
    drawHazards();
    // platforms
    for (const b of bodies) {
      if (b.label === 'plat') drawPlatform(b);
      else if (b.label === 'floor') drawFloor(b);
      else if (b.label.startsWith('p_')) drawPlaced(b);
    }
    if (G.ph === 'plan') drawGhosts();
    drawGoal();
    squirrels.forEach(drawSq);
    drawParts();
    if (G.ph === 'plan') drawCursor();

    if (G.ph === 'run') { physTick(); physTick(); }
    if (G.ph === 'plan') {
      G.pt -= dt / 1000;
      if (G.pt <= 0) { G.pt = 0; run(); }
    }
    tick++; updHUD();
  } else {
    // ambient menu bg
    const g = X.createLinearGradient(0, 0, 0, H);
    g.addColorStop(0, '#071412'); g.addColorStop(1, '#173d22');
    X.fillStyle = g; X.fillRect(0, 0, W, H);
    BG_STARS.forEach(s => {
      const sx2 = wx((s.x + (tick || 0) * 0.06) % 800);
      const tw = 0.3 + 0.4 * Math.sin(tick * 0.018 + s.p);
      X.beginPath(); X.arc(sx2, wy(s.y), s.r, 0, 6.28);
      X.fillStyle = `rgba(255,255,255,${tw})`; X.fill();
    });
    tick = (tick || 0) + 1;
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
