<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SQUIRREL CHAOS</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#1a0a2e;font-family:'Segoe UI',system-ui,sans-serif}
canvas{display:block;position:absolute;top:0;left:0}
#ui{position:absolute;top:0;left:0;width:100%;pointer-events:none;z-index:10}
#hud{display:none;padding:12px 16px;justify-content:space-between;align-items:center}
#hud>div{background:rgba(0,0,0,.55);backdrop-filter:blur(6px);border-radius:14px;padding:6px 14px;color:#fff;font-size:14px;font-weight:700}
.hud-lives{color:#ff6b6b!important}.hud-saved{color:#51cf66!important}.hud-level{color:#ffd43b!important}
#menu,#win,#lose,#lvl-select{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:20;pointer-events:auto}
#menu{background:linear-gradient(135deg,#1a0a2e 0%,#2d1b69 50%,#44318d 100%)}
#win{background:rgba(20,60,20,.92)}
#lose{background:rgba(60,10,10,.92)}
#lvl-select{background:linear-gradient(135deg,#1a0a2e,#2d1b69);overflow-y:auto}
.title{font-size:clamp(28px,7vw,52px);font-weight:900;color:#ffd43b;text-shadow:0 0 30px rgba(255,212,59,.5),0 4px 8px rgba(0,0,0,.5);margin-bottom:8px;text-align:center}
.sub{font-size:clamp(13px,3.5vw,18px);color:rgba(255,255,255,.7);margin-bottom:30px;text-align:center;padding:0 20px;line-height:1.5}
.btn{pointer-events:auto;min-width:200px;padding:14px 28px;border:none;border-radius:16px;font-size:clamp(15px,4vw,20px);font-weight:800;cursor:pointer;transition:transform .15s,box-shadow .15s;text-transform:uppercase;letter-spacing:1px;margin:6px}
.btn:active{transform:scale(.95)}
.btn-play{background:linear-gradient(135deg,#ff6b6b,#ee5a24);color:#fff;box-shadow:0 6px 25px rgba(238,90,36,.5)}
.btn-ok{background:linear-gradient(135deg,#51cf66,#2b8a3e);color:#fff;box-shadow:0 6px 20px rgba(43,138,62,.4)}
.btn-retry{background:linear-gradient(135deg,#ff6b6b,#c92a2a);color:#fff}
.btn-menu{background:rgba(255,255,255,.15);color:#fff;border:2px solid rgba(255,255,255,.3)}
.stars{font-size:clamp(30px,8vw,50px);margin:10px 0}
.stat{color:rgba(255,255,255,.8);font-size:16px;margin:4px 0}
.lvl-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;padding:20px;max-width:400px;width:100%}
.lvl-btn{width:100%;aspect-ratio:1;border-radius:14px;border:2px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);color:#fff;font-size:20px;font-weight:800;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:transform .15s}
.lvl-btn:active{transform:scale(.9)}
.lvl-btn.locked{opacity:.35;pointer-events:none}
.lvl-btn .mini-stars{font-size:10px;margin-top:2px}
#jump-btn{position:absolute;bottom:20px;right:20px;width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,rgba(255,107,107,.85),rgba(238,90,36,.85));border:3px solid rgba(255,255,255,.4);color:#fff;font-size:13px;font-weight:800;z-index:15;pointer-events:auto;display:none;cursor:pointer;text-transform:uppercase;box-shadow:0 4px 20px rgba(238,90,36,.5)}
#jump-btn:active{transform:scale(.88)}
#speed-btns{position:absolute;bottom:20px;left:20px;display:none;z-index:15;gap:8px;pointer-events:auto}
.sp-btn{width:52px;height:52px;border-radius:50%;border:2px solid rgba(255,255,255,.3);background:rgba(0,0,0,.45);color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.sp-btn:active{transform:scale(.88)}
.sp-btn.active{background:rgba(255,212,59,.3);border-color:#ffd43b}
.float-txt{position:absolute;color:#ffd43b;font-weight:800;font-size:18px;pointer-events:none;z-index:25;text-shadow:0 2px 6px rgba(0,0,0,.5);animation:floatUp .8s ease-out forwards}
@keyframes floatUp{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-40px)}}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="ui">
  <div id="hud" style="display:none">
    <div class="hud-lives">üêøÔ∏è <span id="h-alive">5</span></div>
    <div class="hud-level">üèîÔ∏è –£—Ä–æ–≤–µ–Ω—å <span id="h-lvl">1</span></div>
    <div class="hud-saved">üèÅ <span id="h-saved">0</span>/<span id="h-need">3</span></div>
  </div>
</div>
<div id="menu">
  <div class="title">üêøÔ∏è SQUIRREL CHAOS</div>
  <div class="sub">–ü—Ä–æ–≤–µ–¥–∏ –±–µ–ª–æ–∫ —á–µ—Ä–µ–∑ —Å–º–µ—Ä—Ç–µ–ª—å–Ω—ã–µ –ª–æ–≤—É—à–∫–∏!<br>–°–ø–∞—Å–∏ –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ ‚Äî –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∂–¥—ë—Ç —Ö–∞–æ—Å üí•</div>
  <button class="btn btn-play" onclick="showLevels()">–ò–ì–†–ê–¢–¨</button>
</div>
<div id="lvl-select" style="display:none">
  <div class="title" style="font-size:clamp(22px,5vw,34px);margin-top:20px">–í–´–ë–ï–†–ò –£–†–û–í–ï–ù–¨</div>
  <div class="lvl-grid" id="lvl-grid"></div>
  <button class="btn btn-menu" style="margin:16px 0 30px" onclick="showMenu()">–ù–ê–ó–ê–î</button>
</div>
<div id="win" style="display:none">
  <div class="title">–£–†–û–í–ï–ù–¨ –ü–†–û–ô–î–ï–ù!</div>
  <div class="stars" id="w-stars"></div>
  <div class="stat" id="w-stat"></div>
  <button class="btn btn-ok" onclick="nextLevel()">–î–ê–õ–¨–®–ï</button>
  <button class="btn btn-menu" onclick="showLevels()">–£–†–û–í–ù–ò</button>
</div>
<div id="lose" style="display:none">
  <div class="title" style="color:#ff6b6b">–í–°–ï –ü–û–ì–ò–ë–õ–ò üíÄ</div>
  <div class="sub">–ù–∏ –æ–¥–Ω–∞ –±–µ–ª–∫–∞ –Ω–µ –¥–æ–±—Ä–∞–ª–∞—Å—å –¥–æ —Ñ–∏–Ω–∏—à–∞...</div>
  <button class="btn btn-retry" onclick="restartLevel()">–ó–ê–ù–û–í–û</button>
  <button class="btn btn-menu" onclick="showLevels()">–£–†–û–í–ù–ò</button>
</div>
<button id="jump-btn">–ü–†–´–ì</button>
<div id="speed-btns" style="display:none">
  <button class="sp-btn" onclick="setSpeed(-1)">‚è™</button>
  <button class="sp-btn active" id="sp-norm" onclick="setSpeed(0)">‚ñ∂</button>
  <button class="sp-btn" onclick="setSpeed(1)">‚è©</button>
</div>
<script>
const C=document.getElementById('c'),X=C.getContext('2d');
let W,H,dpr;
function resize(){dpr=Math.min(window.devicePixelRatio||1,2);W=window.innerWidth;H=window.innerHeight;C.width=W*dpr;C.height=H*dpr;C.style.width=W+'px';C.style.height=H+'px';X.setTransform(dpr,0,0,dpr,0,0)}
window.addEventListener('resize',resize);resize();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PHYSICS CONSTANTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const GRAV=0.45,FRICTION=0.88,BOUNCE=0.55,SQ_R=12,SQ_WALK=1.4,JUMP_V=-8.5;
const DT=1,SUB_STEPS=3;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEVEL DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// platform: [x,y,w,h, type?]  types: 'normal','ice','bounce','break','move'
// trap: [x,y,w,h, type]  types: 'spike','saw','crusher','flame','swing'
// flag: [x,y]
// spawn: [x,y]
// squirrels: number
// need: minimum saved
// bg: background theme

const LEVELS=[
  { // 1 ‚Äî Tutorial: –ø—Ä–æ—Å—Ç–æ–π
    bg:'forest', squirrels:6, need:3,
    spawn:[60,300],
    platforms:[[0,380,500,40],[150,320,80,12],[300,280,80,12],[460,340,160,40],[580,290,80,12],[680,380,200,40]],
    traps:[[420,360,40,20,'spike']],
    flag:[820,350]
  },
  { // 2
    bg:'forest', squirrels:7, need:4,
    spawn:[40,250],
    platforms:[[0,330,200,40],[250,300,100,12],[400,270,100,12],[500,330,100,40],[620,260,80,12],[750,300,120,40],[900,330,200,40]],
    traps:[[200,310,30,20,'spike'],[500,250,28,28,'saw'],[720,280,30,20,'spike']],
    flag:[1040,300]
  },
  { // 3
    bg:'factory', squirrels:8, need:4,
    spawn:[30,200],
    platforms:[[0,280,160,40],[200,240,80,12],[320,200,100,12],[440,260,80,12],[520,310,120,40],[700,260,80,12],[800,220,80,12],[920,280,200,40]],
    traps:[[160,260,30,20,'spike'],[430,240,28,28,'saw'],[520,230,40,80,'crusher'],[700,200,28,28,'saw']],
    flag:[1060,250]
  },
  { // 4
    bg:'factory', squirrels:8, need:5,
    spawn:[40,150],
    platforms:[[0,230,120,40],[160,190,70,12],[260,150,80,12],[370,200,80,12,'ice'],[480,250,100,40],[620,200,70,12],[730,160,80,12],[850,220,80,12,'bounce'],[960,280,200,40]],
    traps:[[120,210,30,20,'spike'],[260,130,28,28,'saw'],[480,170,40,80,'crusher'],[730,140,28,28,'saw'],[850,260,30,20,'spike']],
    flag:[1100,250]
  },
  { // 5
    bg:'circus', squirrels:10, need:5,
    spawn:[30,120],
    platforms:[[0,200,100,40],[130,160,60,12,'bounce'],[220,120,80,12],[340,170,80,12,'ice'],[450,210,80,12],[560,160,70,12,'bounce'],[670,120,80,12],[780,180,100,40],[920,140,80,12],[1040,200,200,40]],
    traps:[[100,180,30,20,'spike'],[310,150,28,28,'saw'],[450,130,40,80,'crusher'],[560,100,28,28,'saw'],[780,100,50,20,'flame'],[920,120,28,28,'saw']],
    flag:[1180,170]
  },
  { // 6
    bg:'circus', squirrels:10, need:6,
    spawn:[40,100],
    platforms:[[0,180,100,40],[140,140,60,12],[230,100,70,12,'bounce'],[340,160,80,12],[450,120,60,12,'break'],[540,180,120,40],[700,130,80,12,'ice'],[820,90,70,12],[930,150,80,12,'bounce'],[1060,110,80,12],[1170,180,200,40]],
    traps:[[100,160,30,20,'spike'],[340,80,28,28,'saw'],[540,100,40,80,'crusher'],[700,70,28,28,'saw'],[930,130,30,20,'spike'],[1060,170,50,20,'flame']],
    flag:[1310,150]
  },
  { // 7
    bg:'kitchen', squirrels:10, need:5,
    spawn:[30,80],
    platforms:[[0,160,80,40],[120,120,60,12],[220,80,80,12],[340,140,60,12,'move'],[460,100,80,12],[570,160,100,40],[720,110,60,12,'break'],[820,70,80,12,'ice'],[940,130,60,12,'bounce'],[1060,90,80,12],[1170,160,200,40]],
    traps:[[80,140,30,20,'spike'],[220,60,28,28,'saw'],[460,80,28,28,'saw'],[570,80,40,80,'crusher'],[820,50,28,28,'saw'],[1060,150,50,20,'flame']],
    flag:[1310,130]
  },
  { // 8
    bg:'kitchen', squirrels:12, need:6,
    spawn:[20,80],
    platforms:[[0,160,80,40],[110,110,50,12,'bounce'],[200,60,80,12],[320,120,70,12,'ice'],[420,80,60,12,'break'],[510,140,80,12,'move'],[640,90,60,12],[740,50,80,12],[860,110,80,40],[1000,70,60,12,'bounce'],[1100,120,70,12,'break'],[1210,80,80,12],[1320,150,200,40]],
    traps:[[80,140,30,20,'spike'],[200,40,28,28,'saw'],[420,60,28,28,'saw'],[640,70,28,28,'saw'],[860,30,40,80,'crusher'],[1000,50,30,20,'spike'],[1210,140,50,20,'flame']],
    flag:[1460,120]
  },
  { // 9
    bg:'space', squirrels:12, need:7,
    spawn:[30,60],
    platforms:[[0,140,80,40],[120,90,50,12,'bounce'],[220,50,70,12,'ice'],[340,110,60,12,'break'],[430,60,70,12,'move'],[550,120,80,12],[660,70,60,12,'bounce'],[770,30,80,12],[890,90,80,40],[1020,50,60,12,'break'],[1130,100,70,12,'ice'],[1240,60,80,12,'move'],[1370,120,200,40]],
    traps:[[80,120,30,20,'spike'],[220,30,28,28,'saw'],[340,90,28,28,'saw'],[550,40,40,80,'crusher'],[770,10,28,28,'saw'],[1020,30,28,28,'saw'],[1240,100,50,20,'flame']],
    flag:[1510,90]
  },
  { // 10 ‚Äî Boss Level
    bg:'space', squirrels:15, need:8,
    spawn:[20,60],
    platforms:[[0,140,70,40],[100,90,50,12,'bounce'],[190,40,60,12,'ice'],[290,100,50,12,'break'],[370,50,60,12,'move'],[470,110,60,12,'bounce'],[560,60,70,12,'break'],[670,30,60,12,'ice'],[770,90,80,40],[900,40,50,12,'move'],[1000,100,60,12,'bounce'],[1100,50,70,12,'break'],[1210,30,60,12],[1310,90,60,12,'ice'],[1420,60,80,12,'move'],[1540,120,250,40]],
    traps:[[70,120,30,20,'spike'],[190,20,28,28,'saw'],[290,80,28,28,'saw'],[470,30,40,80,'crusher'],[670,10,28,28,'saw'],[900,20,28,28,'saw'],[1100,30,40,80,'crusher'],[1310,70,50,20,'flame'],[1420,100,30,20,'spike']],
    flag:[1720,90]
  }
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let G={lvl:0,phase:'menu',camX:0,camY:0,speedMod:1,squirrels:[],particles:[],floats:[],saved:0,
  progress:JSON.parse(localStorage.getItem('sq_chaos_progress')||'{}')};

function saveProgress(){localStorage.setItem('sq_chaos_progress',JSON.stringify(G.progress))}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SQUIRREL OBJECT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function mkSquirrel(x,y,delay){
  return{
    x:x+Math.random()*30-15, y:y-SQ_R,
    vx:0, vy:0,
    alive:true, saved:false, onGround:false,
    delay:delay||0, active:false,
    angle:0, angV:0,
    eyeBlink:Math.random()*200|0,
    color:`hsl(${20+Math.random()*30},${70+Math.random()*20}%,${45+Math.random()*20}%)`,
    tailPhase:Math.random()*Math.PI*2,
    // ragdoll parts for death
    parts:null, deathTimer:0
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PARTICLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function addParticle(x,y,color,count,spread){
  for(let i=0;i<(count||5);i++){
    let a=Math.random()*Math.PI*2,s=1+Math.random()*(spread||3);
    G.particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-1,life:30+Math.random()*20,maxLife:50,r:2+Math.random()*3,color})
  }
}

function addFloat(x,y,text){
  let el=document.createElement('div');
  el.className='float-txt';el.textContent=text;
  el.style.left=((x-G.camX))+'px';el.style.top=((y-G.camY))+'px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),800);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEVEL INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startLevel(n){
  G.lvl=n;G.phase='play';G.saved=0;G.particles=[];G.floats=[];G.camX=0;G.camY=0;G.speedMod=1;
  let L=LEVELS[n];
  G.squirrels=[];
  for(let i=0;i<L.squirrels;i++){
    G.squirrels.push(mkSquirrel(L.spawn[0],L.spawn[1],i*28));
  }
  G.traps=L.traps.map(t=>({x:t[0],y:t[1],w:t[2],h:t[3],type:t[4],phase:Math.random()*Math.PI*2,timer:0}));
  G.platforms=L.platforms.map(p=>({x:p[0],y:p[1],w:p[2],h:p[3],type:p[4]||'normal',origX:p[0],origY:p[1],breakTimer:0,broken:false}));
  G.flag={x:L.flag[0],y:L.flag[1]};
  G.tick=0;
  document.getElementById('hud').style.display='flex';
  document.getElementById('jump-btn').style.display='block';
  document.getElementById('speed-btns').style.display='flex';
  document.getElementById('menu').style.display='none';
  document.getElementById('lvl-select').style.display='none';
  document.getElementById('win').style.display='none';
  document.getElementById('lose').style.display='none';
  updateHUD();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PHYSICS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateSquirrels(){
  let L=LEVELS[G.lvl];
  G.tick++;
  // update moving platforms
  G.platforms.forEach(p=>{
    if(p.type==='move'&&!p.broken){
      p.x=p.origX+Math.sin(G.tick*0.02)*60;
    }
  });
  G.squirrels.forEach(sq=>{
    if(!sq.alive||sq.saved)return;
    if(sq.delay>0){sq.delay--;return}
    sq.active=true;

    // gravity
    sq.vy+=GRAV;

    // auto walk
    if(sq.onGround)sq.vx=SQ_WALK*G.speedMod;

    // move
    sq.x+=sq.vx*DT;
    sq.y+=sq.vy*DT;

    sq.tailPhase+=0.15;
    sq.eyeBlink--;
    if(sq.eyeBlink<=0)sq.eyeBlink=150+Math.random()*100|0;

    // platform collision
    sq.onGround=false;
    G.platforms.forEach(p=>{
      if(p.broken)return;
      if(sq.x+SQ_R>p.x&&sq.x-SQ_R<p.x+p.w){
        // landing on top
        if(sq.vy>=0&&sq.y+SQ_R>=p.y&&sq.y+SQ_R<=p.y+p.h+sq.vy+2){
          sq.y=p.y-SQ_R;
          if(p.type==='bounce'){sq.vy=JUMP_V*1.3;addParticle(sq.x,sq.y+SQ_R,'#ffe066',6)}
          else{
            sq.vy=0;sq.onGround=true;
            if(p.type==='ice')sq.vx*=1.02;
            else sq.vx*=FRICTION;
            if(p.type==='break'){p.breakTimer++;if(p.breakTimer>30){p.broken=true;addParticle(p.x+p.w/2,p.y,'#aaa',10,4)}}
          }
        }
        // hitting from below
        else if(sq.vy<0&&sq.y-SQ_R<=p.y+p.h&&sq.y-SQ_R>=p.y){
          sq.y=p.y+p.h+SQ_R;sq.vy=1;
        }
      }
      // side collision
      if(sq.y+SQ_R>p.y&&sq.y-SQ_R<p.y+p.h){
        if(sq.vx>0&&sq.x+SQ_R>=p.x&&sq.x+SQ_R<=p.x+8){sq.x=p.x-SQ_R;sq.vx=0}
        if(sq.vx<0&&sq.x-SQ_R<=p.x+p.w&&sq.x-SQ_R>=p.x+p.w-8){sq.x=p.x+p.w+SQ_R;sq.vx=0}
      }
    });

    // trap collision
    G.traps.forEach(t=>{
      let tx=t.x,ty=t.y,tw=t.w,th=t.h;
      if(t.type==='saw'){
        let cx=tx+tw/2,cy=ty+th/2,r=tw/2+4;
        let dx=sq.x-cx,dy=sq.y-cy;
        if(dx*dx+dy*dy<(SQ_R+r)*(SQ_R+r))killSquirrel(sq);
      }else if(t.type==='crusher'){
        let cy=ty+Math.abs(Math.sin(G.tick*0.04+t.phase))*th;
        if(sq.x+SQ_R>tx&&sq.x-SQ_R<tx+tw&&sq.y+SQ_R>cy&&sq.y-SQ_R<cy+20)killSquirrel(sq);
      }else if(t.type==='flame'){
        if(G.tick%80<40){
          if(sq.x+SQ_R>tx&&sq.x-SQ_R<tx+tw&&sq.y+SQ_R>ty-30&&sq.y-SQ_R<ty+th)killSquirrel(sq);
        }
      }else{
        if(sq.x+SQ_R>tx&&sq.x-SQ_R<tx+tw&&sq.y+SQ_R>ty&&sq.y-SQ_R<ty+th)killSquirrel(sq);
      }
    });

    // flag
    let fx=G.flag.x,fy=G.flag.y;
    if(sq.x>fx-20&&sq.x<fx+20&&sq.y>fy-40&&sq.y<fy+10){
      sq.saved=true;G.saved++;
      addParticle(sq.x,sq.y,'#51cf66',12,5);
      addFloat(sq.x,sq.y,'–°–ü–ê–°–ï–ù–ê! üêøÔ∏è');
      updateHUD();
    }

    // fell off
    if(sq.y>600)killSquirrel(sq);
  });

  // check end
  let alive=G.squirrels.filter(s=>s.alive&&!s.saved&&s.active);
  let pending=G.squirrels.filter(s=>s.delay>0);
  if(alive.length===0&&pending.length===0){
    setTimeout(()=>{
      if(G.phase!=='play')return;
      if(G.saved>=LEVELS[G.lvl].need)winLevel();
      else loseLevel();
    },600);
  }
}

function killSquirrel(sq){
  if(!sq.alive)return;
  sq.alive=false;
  addParticle(sq.x,sq.y,'#ff6b6b',15,5);
  addParticle(sq.x,sq.y,sq.color,8,3);
  addFloat(sq.x,sq.y,'üíÄ');
  // ragdoll parts
  sq.parts=[];
  for(let i=0;i<5;i++){
    sq.parts.push({x:sq.x,y:sq.y,vx:(Math.random()-0.5)*6,vy:-3-Math.random()*4,r:3+Math.random()*4,rot:Math.random()*6,color:sq.color});
  }
  sq.deathTimer=60;
  updateHUD();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JUMP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function doJump(){
  if(G.phase!=='play')return;
  G.squirrels.forEach(sq=>{
    if(sq.alive&&!sq.saved&&sq.active&&sq.onGround){
      sq.vy=JUMP_V;sq.onGround=false;
      addParticle(sq.x,sq.y+SQ_R,'#ffd43b',4);
    }
  });
}
document.getElementById('jump-btn').addEventListener('touchstart',e=>{e.preventDefault();doJump()});
document.getElementById('jump-btn').addEventListener('mousedown',doJump);
document.addEventListener('keydown',e=>{if(e.code==='Space'||e.code==='ArrowUp')doJump()});

function setSpeed(v){
  if(v<0)G.speedMod=0.5;
  else if(v>0)G.speedMod=2;
  else G.speedMod=1;
  document.querySelectorAll('.sp-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.sp-btn')[v+1].classList.add('active');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HUD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateHUD(){
  let L=LEVELS[G.lvl];
  let alive=G.squirrels.filter(s=>s.alive&&!s.saved).length;
  document.getElementById('h-alive').textContent=alive;
  document.getElementById('h-saved').textContent=G.saved;
  document.getElementById('h-need').textContent=L.need;
  document.getElementById('h-lvl').textContent=G.lvl+1;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WIN/LOSE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function winLevel(){
  G.phase='win';
  let L=LEVELS[G.lvl];
  let ratio=G.saved/L.squirrels;
  let stars=ratio>=0.9?3:ratio>=0.6?2:1;
  let prev=G.progress[G.lvl]||0;
  if(stars>prev)G.progress[G.lvl]=stars;
  if(!G.progress[G.lvl+1]&&G.lvl+1<LEVELS.length)G.progress[G.lvl+1]=0;
  saveProgress();
  document.getElementById('w-stars').textContent='‚≠ê'.repeat(stars)+'‚òÜ'.repeat(3-stars);
  document.getElementById('w-stat').textContent=`–°–ø–∞—Å–µ–Ω–æ: ${G.saved}/${L.squirrels}`;
  document.getElementById('win').style.display='flex';
  hideGameUI();
}
function loseLevel(){
  G.phase='lose';
  document.getElementById('lose').style.display='flex';
  hideGameUI();
}
function hideGameUI(){
  document.getElementById('hud').style.display='none';
  document.getElementById('jump-btn').style.display='none';
  document.getElementById('speed-btns').style.display='none';
}
function nextLevel(){
  if(G.lvl+1<LEVELS.length)startLevel(G.lvl+1);
  else showLevels();
}
function restartLevel(){startLevel(G.lvl)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MENUS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showMenu(){
  G.phase='menu';hideGameUI();
  document.getElementById('menu').style.display='flex';
  document.getElementById('lvl-select').style.display='none';
  document.getElementById('win').style.display='none';
  document.getElementById('lose').style.display='none';
}
function showLevels(){
  G.phase='menu';hideGameUI();
  document.getElementById('menu').style.display='none';
  document.getElementById('win').style.display='none';
  document.getElementById('lose').style.display='none';
  // ensure level 1 unlocked
  if(G.progress[0]===undefined)G.progress[0]=0;
  let grid=document.getElementById('lvl-grid');grid.innerHTML='';
  for(let i=0;i<LEVELS.length;i++){
    let unlocked=G.progress[i]!==undefined;
    let stars=G.progress[i]||0;
    let btn=document.createElement('button');
    btn.className='lvl-btn'+(unlocked?'':' locked');
    btn.innerHTML=`${i+1}<div class="mini-stars">${unlocked&&stars?'‚≠ê'.repeat(stars):''}</div>`;
    if(unlocked)btn.onclick=()=>startLevel(i);
    grid.appendChild(btn);
  }
  document.getElementById('lvl-select').style.display='flex';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CAMERA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateCamera(){
  let targets=G.squirrels.filter(s=>s.alive&&!s.saved&&s.active);
  if(targets.length===0)return;
  let ax=0,ay=0;
  targets.forEach(s=>{ax+=s.x;ay+=s.y});
  ax/=targets.length;ay/=targets.length;
  let tx=ax-W*0.35,ty=ay-H*0.5;
  G.camX+=(tx-G.camX)*0.08;
  G.camY+=(ty-G.camY)*0.08;
  if(G.camX<0)G.camX=0;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const BG_THEMES={
  forest:{sky:['#0a2a1a','#1a4a2a','#2a6a3a'],ground:'#3a2a1a',accent:'#4a8a3a'},
  factory:{sky:['#1a1a2a','#2a2a3a','#3a3a4a'],ground:'#2a2a2a',accent:'#8a6a3a'},
  circus:{sky:['#2a0a3a','#4a1a5a','#6a2a7a'],ground:'#3a1a2a',accent:'#da4a8a'},
  kitchen:{sky:['#2a1a0a','#4a3a1a','#6a5a2a'],ground:'#4a3a2a',accent:'#da8a3a'},
  space:{sky:['#0a0a1a','#0a0a2a','#1a0a3a'],ground:'#1a1a2a',accent:'#4a6afa'}
};

let bgStars=[];for(let i=0;i<80;i++)bgStars.push({x:Math.random()*2000,y:Math.random()*500,r:0.5+Math.random()*1.5,blink:Math.random()*200|0});

function drawBg(){
  let theme=BG_THEMES[LEVELS[G.lvl].bg];
  let grd=X.createLinearGradient(0,0,0,H);
  grd.addColorStop(0,theme.sky[0]);grd.addColorStop(0.5,theme.sky[1]);grd.addColorStop(1,theme.sky[2]);
  X.fillStyle=grd;X.fillRect(0,0,W,H);
  // stars
  bgStars.forEach(s=>{
    let sx=((s.x-G.camX*0.2)%W+W)%W, sy=((s.y-G.camY*0.1)%H+H)%H;
    s.blink--;if(s.blink<=0)s.blink=100+Math.random()*200|0;
    let alpha=s.blink<10?0.3:0.7+Math.random()*0.3;
    X.beginPath();X.arc(sx,sy,s.r,0,Math.PI*2);
    X.fillStyle=`rgba(255,255,255,${alpha})`;X.fill();
  });
}

function drawPlatform(p){
  let px=p.x-G.camX,py=p.y-G.camY;
  if(px+p.w<-50||px>W+50)return;
  if(p.broken){
    X.globalAlpha=0.3;
    X.fillStyle='#555';
    X.fillRect(px,py,p.w,p.h);
    X.globalAlpha=1;return;
  }
  let colors={normal:'#5a7a3a',ice:'#6acfdf',bounce:'#ffe066',break:'#c0a080',move:'#a06adf'};
  let c=colors[p.type]||colors.normal;
  // shadow
  X.fillStyle='rgba(0,0,0,.25)';
  X.fillRect(px+3,py+3,p.w,p.h);
  // main
  let g=X.createLinearGradient(px,py,px,py+p.h);
  g.addColorStop(0,c);g.addColorStop(1,shadeColor(c,-30));
  X.fillStyle=g;
  roundRect(px,py,p.w,p.h,4);X.fill();
  // top highlight
  X.fillStyle='rgba(255,255,255,.2)';
  X.fillRect(px+2,py,p.w-4,3);
  // grass on normal
  if(p.type==='normal'){
    X.fillStyle='#6a9a4a';
    for(let i=px;i<px+p.w;i+=6){
      X.fillRect(i,py-2,3,4);
    }
  }
  // break cracks
  if(p.type==='break'&&p.breakTimer>10){
    X.strokeStyle='rgba(0,0,0,.4)';X.lineWidth=1;
    X.beginPath();X.moveTo(px+p.w*0.3,py);X.lineTo(px+p.w*0.5,py+p.h);X.stroke();
    X.beginPath();X.moveTo(px+p.w*0.7,py);X.lineTo(px+p.w*0.5,py+p.h*0.5);X.stroke();
  }
}

function drawTrap(t){
  let tx=t.x-G.camX,ty=t.y-G.camY;
  if(tx+t.w<-50||tx>W+50)return;
  t.phase+=0.08;
  if(t.type==='spike'){
    X.fillStyle='#888';
    for(let i=0;i<t.w;i+=8){
      X.beginPath();X.moveTo(tx+i,ty+t.h);X.lineTo(tx+i+4,ty);X.lineTo(tx+i+8,ty+t.h);X.fill();
    }
  }else if(t.type==='saw'){
    let cx=tx+t.w/2,cy=ty+t.h/2,r=t.w/2;
    X.save();X.translate(cx,cy);X.rotate(t.phase*2);
    X.beginPath();
    for(let i=0;i<12;i++){
      let a=i/12*Math.PI*2,ri=i%2?r:r*0.7;
      i?X.lineTo(Math.cos(a)*ri,Math.sin(a)*ri):X.moveTo(Math.cos(a)*ri,Math.sin(a)*ri);
    }
    X.closePath();X.fillStyle='#bbb';X.fill();
    X.beginPath();X.arc(0,0,r*0.25,0,Math.PI*2);X.fillStyle='#666';X.fill();
    X.restore();
    // glow
    X.beginPath();X.arc(cx,cy,r+4,0,Math.PI*2);
    X.strokeStyle='rgba(255,100,100,.3)';X.lineWidth=2;X.stroke();
  }else if(t.type==='crusher'){
    let cy2=ty+Math.abs(Math.sin(G.tick*0.04+t.phase))*t.h;
    X.fillStyle='#999';X.fillRect(tx,ty-10,t.w,12);
    X.fillStyle='#777';X.fillRect(tx+2,ty,t.w-4,cy2-ty);
    X.fillStyle='#666';
    X.beginPath();X.moveTo(tx,cy2+20);X.lineTo(tx+t.w/2,cy2);X.lineTo(tx+t.w,cy2+20);X.fill();
  }else if(t.type==='flame'){
    if(G.tick%80<40){
      for(let i=0;i<8;i++){
        let fx=tx+Math.random()*t.w,fy=ty-Math.random()*30;
        let fr=3+Math.random()*5;
        X.beginPath();X.arc(fx,fy,fr,0,Math.PI*2);
        X.fillStyle=`rgba(${255},${100+Math.random()*100|0},${Math.random()*50|0},.7)`;X.fill();
      }
    }
    X.fillStyle='#555';X.fillRect(tx,ty,t.w,t.h);
  }
}

function drawSquirrel(sq){
  if(sq.saved)return;
  if(!sq.alive){
    // ragdoll parts
    if(sq.parts&&sq.deathTimer>0){
      sq.deathTimer--;
      sq.parts.forEach(p=>{
        p.x+=p.vx;p.y+=p.vy;p.vy+=0.3;p.rot+=0.2;
        let px=p.x-G.camX,py=p.y-G.camY;
        X.save();X.translate(px,py);X.rotate(p.rot);
        X.beginPath();X.arc(0,0,p.r,0,Math.PI*2);
        X.fillStyle=p.color;X.globalAlpha=sq.deathTimer/60;X.fill();
        X.restore();X.globalAlpha=1;
      });
    }
    return;
  }
  if(!sq.active)return;
  let sx=sq.x-G.camX,sy=sq.y-G.camY;
  if(sx<-30||sx>W+30)return;

  X.save();X.translate(sx,sy);

  // shadow
  X.beginPath();X.ellipse(0,SQ_R+2,SQ_R*0.8,4,0,0,Math.PI*2);
  X.fillStyle='rgba(0,0,0,.2)';X.fill();

  // tail
  let tw=Math.sin(sq.tailPhase)*5;
  X.beginPath();X.moveTo(-4,-SQ_R+2);
  X.quadraticCurveTo(-SQ_R-6+tw,-SQ_R-10,-SQ_R+2,-SQ_R-16);
  X.quadraticCurveTo(-SQ_R-2+tw,-SQ_R-8,-2,-SQ_R+4);
  X.fillStyle=shadeColor(sq.color,-15);X.fill();

  // body
  X.beginPath();X.arc(0,0,SQ_R,0,Math.PI*2);
  let bg=X.createRadialGradient(-3,-3,1,0,0,SQ_R);
  bg.addColorStop(0,shadeColor(sq.color,20));bg.addColorStop(1,sq.color);
  X.fillStyle=bg;X.fill();
  // belly
  X.beginPath();X.ellipse(0,3,SQ_R*0.6,SQ_R*0.5,0,0,Math.PI*2);
  X.fillStyle=shadeColor(sq.color,40);X.fill();

  // ears
  X.fillStyle=sq.color;
  [[-6,-SQ_R+1],[6,-SQ_R+1]].forEach(([ex,ey])=>{
    X.beginPath();X.ellipse(ex,ey-4,3,5,ex<0?-0.3:0.3,0,Math.PI*2);X.fill();
    X.beginPath();X.ellipse(ex,ey-4,1.5,3,ex<0?-0.3:0.3,0,Math.PI*2);
    X.fillStyle='#fca';X.fill();X.fillStyle=sq.color;
  });

  // eyes
  let blink=sq.eyeBlink<5;
  let ew=blink?3:3,eh=blink?1:4;
  [[-4,-3],[4,-3]].forEach(([ex,ey])=>{
    X.beginPath();X.ellipse(ex,ey,ew,eh,0,0,Math.PI*2);
    X.fillStyle='#fff';X.fill();
    if(!blink){
      X.beginPath();X.arc(ex+1,ey,1.5,0,Math.PI*2);
      X.fillStyle='#222';X.fill();
      X.beginPath();X.arc(ex+1.5,ey-1,0.6,0,Math.PI*2);
      X.fillStyle='#fff';X.fill();
    }
  });

  // nose
  X.beginPath();X.arc(0,1,1.5,0,Math.PI*2);X.fillStyle='#c44';X.fill();

  // cheeks
  X.globalAlpha=0.3;
  X.beginPath();X.arc(-6,2,3,0,Math.PI*2);X.fillStyle='#faa';X.fill();
  X.beginPath();X.arc(6,2,3,0,Math.PI*2);X.fill();
  X.globalAlpha=1;

  // feet (when on ground, wiggle)
  if(sq.onGround){
    let fw=Math.sin(G.tick*0.2)*2;
    X.fillStyle=shadeColor(sq.color,-20);
    X.beginPath();X.ellipse(-4+fw,SQ_R,3,2,0,0,Math.PI*2);X.fill();
    X.beginPath();X.ellipse(4-fw,SQ_R,3,2,0,0,Math.PI*2);X.fill();
  }

  X.restore();
}

function drawFlag(){
  let fx=G.flag.x-G.camX,fy=G.flag.y-G.camY;
  // pole
  X.fillStyle='#ccc';X.fillRect(fx-2,fy-40,4,42);
  // flag wave
  let wave=Math.sin(G.tick*0.06)*3;
  X.fillStyle='#51cf66';
  X.beginPath();X.moveTo(fx+2,fy-40);X.lineTo(fx+26+wave,fy-34);X.lineTo(fx+2,fy-24);X.fill();
  // star
  X.fillStyle='#fff';X.font='10px sans-serif';X.fillText('üèÅ',fx+6,fy-30);
  // base
  X.fillStyle='#888';roundRect(fx-8,fy,16,4,2);X.fill();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER PARTICLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function drawParticles(){
  G.particles=G.particles.filter(p=>{
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.1;p.life--;
    if(p.life<=0)return false;
    let px=p.x-G.camX,py=p.y-G.camY;
    X.beginPath();X.arc(px,py,p.r*(p.life/p.maxLife),0,Math.PI*2);
    X.fillStyle=p.color;X.globalAlpha=p.life/p.maxLife;X.fill();X.globalAlpha=1;
    return true;
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function roundRect(x,y,w,h,r){X.beginPath();X.moveTo(x+r,y);X.lineTo(x+w-r,y);X.quadraticCurveTo(x+w,y,x+w,y+r);X.lineTo(x+w,y+h-r);X.quadraticCurveTo(x+w,y+h,x+w-r,y+h);X.lineTo(x+r,y+h);X.quadraticCurveTo(x,y+h,x,y+h-r);X.lineTo(x,y+r);X.quadraticCurveTo(x,y,x+r,y);X.closePath()}
function shadeColor(col,amt){
  let r,g,b;
  if(col.startsWith('#')){
    let n=parseInt(col.slice(1),16);r=(n>>16)&255;g=(n>>8)&255;b=n&255;
  }else if(col.startsWith('hsl')){
    // approximate
    return col;
  }else return col;
  r=Math.max(0,Math.min(255,r+amt));g=Math.max(0,Math.min(255,g+amt));b=Math.max(0,Math.min(255,b+amt));
  return `rgb(${r},${g},${b})`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN LOOP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function loop(){
  X.clearRect(0,0,W,H);
  if(G.phase==='play'){
    for(let i=0;i<SUB_STEPS;i++)updateSquirrels();
    updateCamera();
    drawBg();
    G.platforms.forEach(drawPlatform);
    G.traps.forEach(drawTrap);
    drawFlag();
    G.squirrels.forEach(drawSquirrel);
    drawParticles();
  }else{
    // ambient bg in menus
    let grd=X.createLinearGradient(0,0,0,H);
    grd.addColorStop(0,'#1a0a2e');grd.addColorStop(1,'#2d1b69');
    X.fillStyle=grd;X.fillRect(0,0,W,H);
    bgStars.forEach(s=>{
      let sx=(s.x+G.tick*0.1)%W,sy=s.y%H;
      X.beginPath();X.arc(sx,sy,s.r,0,Math.PI*2);
      X.fillStyle=`rgba(255,255,255,${0.4+Math.random()*0.4})`;X.fill();
    });
    G.tick=(G.tick||0)+1;
  }
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
