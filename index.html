<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>NUTFALL</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{width:100%;height:100%;overflow:hidden;background:#060d06;font-family:'SF Pro Display','Segoe UI',system-ui,sans-serif}
canvas{display:block;position:fixed;top:0;left:0;z-index:1;touch-action:none}
.ov{position:fixed;top:0;left:0;width:100%;height:100%;z-index:40;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .4s}
.ov.h{opacity:0;pointer-events:none}
#card{background:rgba(8,20,10,.92);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.06);border-radius:24px;padding:32px 28px 24px;max-width:340px;width:85%;display:flex;flex-direction:column;align-items:center}
.lg{font-size:52px;margin-bottom:4px;filter:drop-shadow(0 4px 12px rgba(255,200,50,.3))}
.tt{font-size:clamp(22px,6vw,34px);font-weight:900;letter-spacing:-.5px;text-align:center;margin-bottom:2px}
.ty{color:#ffd54f;text-shadow:0 0 30px rgba(255,213,79,.25)}
.tg{color:#a5d6a7}.tr{color:#ef9a9a}
.ds{font-size:clamp(11px,2.8vw,13px);color:rgba(255,255,255,.4);text-align:center;line-height:1.5;margin:10px 0 20px}
.b{width:100%;padding:14px;border:none;border-radius:14px;font-size:15px;font-weight:800;cursor:pointer;margin:4px 0;text-transform:uppercase;transition:transform .12s;pointer-events:auto}
.b:active{transform:scale(.95)}
.bg{background:linear-gradient(135deg,#66bb6a,#2e7d32);color:#fff;box-shadow:0 6px 24px rgba(46,125,50,.3)}
.br{background:linear-gradient(135deg,#ef5350,#c62828);color:#fff}
.stars{font-size:clamp(28px,7vw,42px);margin:6px 0;letter-spacing:4px}
.st{color:rgba(255,255,255,.45);font-size:13px;margin-bottom:12px}
/* HUD */
#hud{position:fixed;top:0;left:0;width:100%;z-index:20;display:none;padding:8px 12px;pointer-events:none}
#hr{display:flex;justify-content:space-between;align-items:center}
.pl{background:rgba(6,14,8,.65);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-radius:18px;padding:5px 12px;color:#fff;font-size:12px;font-weight:700;display:flex;align-items:center;gap:4px;border:1px solid rgba(255,255,255,.04)}
.pl i{font-style:normal;font-size:14px}
#tbw{width:100%;height:4px;background:rgba(255,255,255,.04);border-radius:2px;margin-top:6px;overflow:hidden}
#tbf{height:100%;border-radius:2px;transition:width .2s}
/* Toolbar */
#toolbar{position:fixed;bottom:0;left:0;width:100%;z-index:20;display:none}
#tbi{display:flex;align-items:stretch;justify-content:center;gap:6px;padding:8px 8px max(12px,env(safe-area-inset-bottom));background:rgba(6,14,8,.8);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);border-top:1px solid rgba(255,255,255,.04);overflow-x:auto;pointer-events:auto}
.tb{min-width:50px;height:52px;border-radius:14px;border:1.5px solid rgba(255,255,255,.06);background:rgba(255,255,255,.03);color:#fff;font-size:9px;font-weight:700;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;flex-shrink:0;transition:all .15s;pointer-events:auto}
.tb em{font-style:normal;font-size:18px}.tb small{font-size:8px;opacity:.4}
.tb:active{transform:scale(.88)}
.tb.sel{border-color:rgba(255,213,79,.4);background:rgba(255,213,79,.08)}
.tb.dis{opacity:.2;pointer-events:none}
#go{min-width:58px;background:linear-gradient(135deg,#66bb6a,#2e7d32)!important;border-color:rgba(255,255,255,.1)!important;font-size:10px}
#tut{position:fixed;bottom:76px;left:50%;transform:translateX(-50%);background:rgba(6,14,8,.88);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);color:rgba(255,255,255,.6);padding:10px 18px;border-radius:14px;font-size:11px;font-weight:600;z-index:25;display:none;text-align:center;max-width:88%;line-height:1.4;pointer-events:none;border:1px solid rgba(255,255,255,.04)}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="hud"><div id="hr"><div class="pl"><i>üêøÔ∏è</i><span id="ha">6</span></div><div class="pl"><i>‚è±</i><span id="ht">35</span>—Å</div><div class="pl"><i>üå∞</i><span id="hs">0</span>/<span id="hn">4</span></div></div><div id="tbw"><div id="tbf"></div></div></div>
<div id="toolbar"><div id="tbi"></div></div>
<div id="tut"></div>

<div class="ov" id="sm"><div id="card"><div class="lg">üêøÔ∏è</div><div class="tt ty">NUTFALL</div><div class="ds">–†–∞—Å—Å—Ç–∞–≤—å –ø—Ä–µ–¥–º–µ—Ç—ã, —á—Ç–æ–±—ã –±–µ–ª–∫–∏ –¥–æ–±–µ–∂–∞–ª–∏ –¥–æ –æ—Ä–µ—Ö–∞!<br><br>–¢–∞–ø ‚Äî –ø–æ—Å—Ç–∞–≤–∏—Ç—å ¬∑ –¢–∞–ø –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É ‚Äî —É–±—Ä–∞—Ç—å<br>‚Ü∫ ‚Üª ‚Äî –ø–æ–≤–µ—Ä–Ω—É—Ç—å</div><button class="b bg" id="b1">–ù–∞—á–∞—Ç—å</button></div></div>
<div class="ov h" id="sw"><div id="card"><div class="lg">üéâ</div><div class="tt tg">–û—Ç–ª–∏—á–Ω–æ!</div><div class="stars" id="ws"></div><div class="st" id="wt"></div><button class="b bg" id="b2">–ï—â—ë —Ä–∞–∑</button></div></div>
<div class="ov h" id="sl"><div id="card"><div class="lg">üíÄ</div><div class="tt tr">–ù–µ —Ö–≤–∞—Ç–∏–ª–æ</div><div class="st" id="lt"></div><button class="b br" id="b3">–ó–∞–Ω–æ–≤–æ</button></div></div>

<script>
const $=id=>document.getElementById(id),C=$('c'),X=C.getContext('2d');

/* ‚îÄ‚îÄ‚îÄ WORLD: 400 wide √ó 700 tall (vertical!) ‚îÄ‚îÄ‚îÄ */
const WW=400, WH=700;
let W,H,SC;

function resize(){
  W=innerWidth;H=innerHeight;
  const d=Math.min(devicePixelRatio||1,2);
  C.width=W*d;C.height=H*d;
  C.style.width=W+'px';C.style.height=H+'px';
  X.setTransform(d,0,0,d,0,0);
  SC=Math.min(W/WW, H/WH); // uniform scale
}
addEventListener('resize',resize);resize();

function wx(v){return v*W/WW}
function wy(v){return v*H/WH}
function s2w(sx,sy){return{x:sx*WW/W,y:sy*WH/H}}

/* ‚îÄ‚îÄ‚îÄ PHYSICS ‚îÄ‚îÄ‚îÄ */
const GRAV=0.32;
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}

class Rect{
  constructor(cx,cy,w,h,o={}){
    this.cx=cx;this.cy=cy;this.hw=w/2;this.hh=h/2;
    this.a=o.a||0;this.cos=Math.cos(this.a);this.sin=Math.sin(this.a);
    this.label=o.label||'';this.bouncy=!!o.bouncy;
  }
}

function circRect(cx,cy,cr,r){
  const dx=cx-r.cx,dy=cy-r.cy;
  const lx=dx*r.cos+dy*r.sin,ly=-dx*r.sin+dy*r.cos;
  const clx=clamp(lx,-r.hw,r.hw),cly=clamp(ly,-r.hh,r.hh);
  const ex=lx-clx,ey=ly-cly,d2=ex*ex+ey*ey;
  if(d2>=cr*cr)return null;
  const d=Math.sqrt(d2)||.001,pen=cr-d;
  const nlx=ex/d,nly=ey/d;
  return{pen,nx:nlx*r.cos-nly*r.sin,ny:nlx*r.sin+nly*r.cos};
}

/* ‚îÄ‚îÄ‚îÄ LEVEL (vertical layout, everything big) ‚îÄ‚îÄ‚îÄ */
const LV={
  sq:6, need:4, time:40,
  spawn:{x:60, y:200},
  goal:{x:320, y:530},
  plats:[
    {x:10,  y:260, w:160, h:22},   // top-left start
    {x:180, y:360, w:100, h:18},   // middle stepping stone
    {x:60,  y:460, w:120, h:18},   // mid-left
    {x:230, y:560, w:170, h:22},   // bottom-right with goal
  ],
  haz:[
    {x:130, y:380, w:50,  h:30, t:'spike'},
    {x:170, y:580, w:60,  h:24, t:'water'},
  ],
  tools:{plank:4, box:3, trampoline:1}
};

const ITEMS={
  plank:{n:'–î–æ—Å–∫–∞',ic:'üìè',w:70,h:10,rot:1},
  box:{n:'–Ø—â–∏–∫',ic:'üì¶',w:28,h:28},
  trampoline:{n:'–ë–∞—Ç—É—Ç',ic:'üíé',w:50,h:9,bouncy:1},
};

/* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ */
let bodies=[],sqs=[],parts=[],tick=0;
let G={ph:'start',placed:[],sel:null,ga:0,pt:0,saved:0,tb:{}};

/* ‚îÄ‚îÄ‚îÄ SQUIRREL (big, detailed, 18px radius in world units) ‚îÄ‚îÄ‚îÄ */
class Sq{
  constructor(x,y,del){
    this.x=x;this.y=y;this.vx=0;this.vy=0;this.r=18;
    this.alive=true;this.saved=false;this.ground=false;
    this.del=del;this.on=false;this.dir=1;this.spd=0.9+Math.random()*.3;
    this.hue=22+Math.random()*28|0;this.sat=68+Math.random()*20|0;this.lit=44+Math.random()*18|0;
    this.tail=Math.random()*6.28;this.blink=80+Math.random()*150|0;
    this.jcd=0;this.stk=0;this.lx=x;this.at=0;this.dt=80;
    this.breathe=Math.random()*6.28;this.ear=Math.random()*6.28;
    this.runFrame=0;
  }
  get col(){return`hsl(${this.hue},${this.sat}%,${this.lit}%)`}
  get colL(){return`hsl(${this.hue},${this.sat}%,${this.lit+22}%)`}
  get colD(){return`hsl(${this.hue},${this.sat}%,${Math.max(0,this.lit-18)}%)`}
  get belly(){return`hsl(${this.hue-5},${this.sat-15}%,${this.lit+30}%)`}
  get earIn(){return`hsl(${this.hue+15},50%,72%)`}
}

function spawnP(x,y,col,n=8,sp=3){
  for(let i=0;i<n;i++){const a=Math.random()*6.28,v=.5+Math.random()*sp;
    parts.push({x,y,vx:Math.cos(a)*v,vy:Math.sin(a)*v-1.2,life:25+Math.random()*28|0,ml:53,r:2+Math.random()*4,col})}
}

/* ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ */
function init(){
  G.ph='plan';G.saved=0;G.sel=null;G.ga=0;G.placed=[];tick=0;
  bodies=[];sqs=[];parts=[];G.pt=LV.time;
  G.tb={};for(let k in LV.tools)G.tb[k]=LV.tools[k];
  LV.plats.forEach(p=>bodies.push(new Rect(p.x+p.w/2,p.y+p.h/2,p.w,p.h,{label:'plat'})));
  bodies.push(new Rect(WW/2,WH+10,WW+40,20,{label:'floor'}));
  bodies.push(new Rect(-10,WH/2,20,WH+40,{label:'wall'}));
  bodies.push(new Rect(WW+10,WH/2,20,WH+40,{label:'wall'}));
  ['sm','sw','sl'].forEach(id=>{$(id).classList.add('h');$(id).style.display='none'});
  $('hud').style.display='block';buildTB();updHUD();
  showTut('–í—ã–±–µ—Ä–∏ –ø—Ä–µ–¥–º–µ—Ç ‚Üí —Ç–∞–ø–Ω–∏ –Ω–∞ –ø–æ–ª–µ\n–¢–∞–ø–Ω–∏ —Ä–∞–∑–º–µ—â—ë–Ω–Ω—ã–π ‚Äî —É–±—Ä–∞—Ç—å\n‚Ü∫‚Üª –ø–æ–≤–µ—Ä–Ω—É—Ç—å ¬∑ ‚ñ∂ –ü–£–°–ö');
}

function run(){
  G.ph='run';G.sel=null;hideTut();
  G.placed.forEach(it=>{const d=ITEMS[it.type];
    bodies.push(new Rect(it.x,it.y,d.w,d.h,{label:'p_'+it.type,a:it.a,bouncy:!!d.bouncy}))});
  for(let i=0;i<LV.sq;i++)sqs.push(new Sq(LV.spawn.x,LV.spawn.y,i*24));
  buildTB();
}

/* ‚îÄ‚îÄ‚îÄ SQUIRREL AI ‚îÄ‚îÄ‚îÄ */
function updSq(sq){
  if(!sq.alive||sq.saved||!sq.on)return;
  sq.vy+=GRAV;
  // find direction to goal ‚Äî try to go there
  const gx=LV.goal.x,gy=LV.goal.y;
  const dx=gx-sq.x,dy=gy-sq.y;
  // prefer horizontal direction toward goal
  sq.dir=dx>0?1:dx<0?-1:sq.dir;
  if(sq.ground){sq.vx=sq.dir*sq.spd;sq.runFrame+=.15}
  sq.at++;
  if(sq.at%20===0){
    if(Math.abs(sq.x-sq.lx)<1&&sq.ground){
      sq.stk++;
      if(sq.stk>2&&sq.jcd<=0){sq.vy=-6.5-Math.random()*1.5;sq.vx=sq.dir*(1.8+Math.random()*1.2);sq.ground=false;sq.jcd=30;sq.stk=0}
    }else sq.stk=0;
    sq.lx=sq.x;
  }
  if(sq.jcd>0)sq.jcd--;
  sq.x+=sq.vx;sq.y+=sq.vy;sq.vx*=.985;
  sq.tail+=.14;sq.breathe+=.035;sq.ear+=.07;
  sq.blink--;if(sq.blink<=0)sq.blink=90+Math.random()*140|0;
  sq.ground=false;
  for(const b of bodies){
    const c=circRect(sq.x,sq.y,sq.r,b);if(!c)continue;
    sq.x+=c.nx*c.pen;sq.y+=c.ny*c.pen;
    if(c.ny<-.4){sq.ground=true;sq.vy=0;
      if(b.bouncy){sq.vy=-9.5-Math.random()*1.5;sq.ground=false;spawnP(sq.x,sq.y+sq.r,'#4fc3f7',8,2.5)}}
    else{const dot=sq.vx*c.nx+sq.vy*c.ny;sq.vx-=dot*c.nx*.5;sq.vy-=dot*c.ny*.5}}
  for(const hz of LV.haz)
    if(sq.x+sq.r>hz.x&&sq.x-sq.r<hz.x+hz.w&&sq.y+sq.r>hz.y&&sq.y-sq.r<hz.y+hz.h)killSq(sq);
  if(Math.abs(sq.x-gx)<30&&Math.abs(sq.y-gy)<36){
    sq.saved=true;G.saved++;spawnP(sq.x,sq.y,'#ffd54f',22,5);spawnP(sq.x,sq.y,'#fff',10,3);updHUD()}
  if(sq.y>WH+20||sq.x<-30||sq.x>WW+30)killSq(sq);
}

function killSq(sq){if(!sq.alive)return;sq.alive=false;sq.dt=70;
  spawnP(sq.x,sq.y,'#ef5350',14,4);spawnP(sq.x,sq.y,sq.col,10,3);updHUD()}

function physTick(){tick++;
  sqs.forEach(sq=>{if(sq.del>0){sq.del--;return}if(!sq.on)sq.on=true;updSq(sq)});
  if(G.ph!=='run')return;
  const alive=sqs.filter(s=>s.alive&&!s.saved),wait=sqs.filter(s=>s.del>0);
  if(alive.length===0&&wait.length===0)
    setTimeout(()=>{if(G.ph!=='run')return;G.saved>=LV.need?doWin():doLose()},600);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDERING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// ‚îÄ‚îÄ background ‚îÄ‚îÄ
let fireflies=[];for(let i=0;i<15;i++)fireflies.push({x:Math.random()*WW,y:WH*.3+Math.random()*WH*.5,vx:(Math.random()-.5)*.2,vy:(Math.random()-.5)*.15,p:Math.random()*6.28,r:1.5+Math.random()*2});

function drawBg(){
  // sky gradient
  const sg=X.createLinearGradient(0,0,0,H);
  sg.addColorStop(0,'#030a05');sg.addColorStop(.2,'#081a0e');sg.addColorStop(.5,'#0e2816');sg.addColorStop(.8,'#122e1a');sg.addColorStop(1,'#0a1e10');
  X.fillStyle=sg;X.fillRect(0,0,W,H);

  // moon
  const mx=wx(320),my=wy(60);
  const mg=X.createRadialGradient(mx,my,0,mx,my,wx(60));
  mg.addColorStop(0,'rgba(200,220,200,.05)');mg.addColorStop(1,'rgba(0,0,0,0)');
  X.fillStyle=mg;X.fillRect(0,0,W,H);
  X.beginPath();X.arc(mx,my,wx(8),0,6.28);
  const mc=X.createRadialGradient(mx-wx(2),my-wy(1),0,mx,my,wx(8));
  mc.addColorStop(0,'rgba(235,242,230,.85)');mc.addColorStop(1,'rgba(180,200,170,.15)');
  X.fillStyle=mc;X.fill();

  // stars
  const stars=[
    [40,30,1],[120,50,1.3],[200,25,0.8],[280,45,1.1],[350,35,0.9],
    [70,80,0.7],[160,90,1.2],[250,70,0.8],[330,85,1],[60,120,1.1],
    [180,110,0.9],[300,100,0.7],[380,60,1.3],[100,140,0.8],[240,130,1]
  ];
  stars.forEach(([sx,sy,sr],i)=>{
    const a=.25+.55*(.5+.5*Math.sin(tick*.016+i*2.1));
    X.beginPath();X.arc(wx(sx),wy(sy),sr*W/400,0,6.28);
    X.fillStyle=`rgba(210,230,210,${a})`;X.fill();
  });

  // tree silhouettes (3 layers, big for vertical view)
  for(let layer=0;layer<3;layer++){
    const baseY=wy(480+layer*30);
    X.fillStyle=`rgba(5,${16-layer*3},${7-layer*2},${.1+layer*.06})`;
    const count=8+layer*4;
    for(let i=0;i<count;i++){
      const tx=(i/(count-1))*W+Math.sin(i*3.1+layer)*wx(15);
      const th=(60+Math.sin(i*1.3+layer*2)*25+layer*12)*H/WH;
      const tw=(12+layer*4)*W/WW;
      X.beginPath();X.moveTo(tx,baseY);
      X.lineTo(tx+tw*.1,baseY-th*.35);X.lineTo(tx-tw*.35,baseY-th*.35);
      X.lineTo(tx+tw*.08,baseY-th*.65);X.lineTo(tx-tw*.25,baseY-th*.65);
      X.lineTo(tx,baseY-th);
      X.lineTo(tx+tw*.25,baseY-th*.65);X.lineTo(tx-tw*.08,baseY-th*.65);
      X.lineTo(tx+tw*.35,baseY-th*.35);X.lineTo(tx-tw*.1,baseY-th*.35);
      X.fill();
    }
  }

  // ground gradient
  const gg=X.createLinearGradient(0,wy(560),0,H);
  gg.addColorStop(0,'#152a12');gg.addColorStop(1,'#0a1808');
  X.fillStyle=gg;X.fillRect(0,wy(560),W,H-wy(560));

  // fireflies
  fireflies.forEach(f=>{
    f.x+=f.vx+Math.sin(tick*.018+f.p)*.12;f.y+=f.vy+Math.cos(tick*.013+f.p)*.08;
    if(f.x<0)f.x=WW;if(f.x>WW)f.x=0;if(f.y<WH*.25)f.y=WH*.7;if(f.y>WH*.85)f.y=WH*.3;
    const gl=.15+.5*(.5+.5*Math.sin(tick*.035+f.p));
    X.beginPath();X.arc(wx(f.x),wy(f.y),f.r*W/WW,0,6.28);
    X.fillStyle=`rgba(180,255,100,${gl})`;X.fill();
    X.beginPath();X.arc(wx(f.x),wy(f.y),f.r*6*W/WW,0,6.28);
    X.fillStyle=`rgba(180,255,100,${gl*.04})`;X.fill();
  });

  // goal glow
  const gx2=wx(LV.goal.x),gy2=wy(LV.goal.y);
  const rg=X.createRadialGradient(gx2,gy2,0,gx2,gy2,wx(80));
  rg.addColorStop(0,'rgba(255,213,79,.04)');rg.addColorStop(1,'rgba(0,0,0,0)');
  X.fillStyle=rg;X.fillRect(0,0,W,H);
}

function rr(x,y,w,h,r){X.beginPath();X.moveTo(x+r,y);X.lineTo(x+w-r,y);X.quadraticCurveTo(x+w,y,x+w,y+r);X.lineTo(x+w,y+h-r);X.quadraticCurveTo(x+w,y+h,x+w-r,y+h);X.lineTo(x+r,y+h);X.quadraticCurveTo(x,y+h,x,y+h-r);X.lineTo(x,y+r);X.quadraticCurveTo(x,y,x+r,y);X.closePath()}

function drawPlat(b){
  const x1=wx(b.cx-b.hw),y1=wy(b.cy-b.hh),pw=wx(b.hw*2),ph=wy(b.hh*2);
  const rad=Math.min(wx(6),pw/4);
  X.save();X.shadowColor='rgba(0,0,0,.2)';X.shadowBlur=wx(10);X.shadowOffsetY=wy(4);
  const pg=X.createLinearGradient(x1,y1,x1,y1+ph);
  pg.addColorStop(0,'#5e9b3c');pg.addColorStop(.4,'#4a8230');pg.addColorStop(1,'#3a6924');
  X.fillStyle=pg;rr(x1,y1,pw,ph,rad);X.fill();X.restore();
  // top grass
  const gh=Math.max(wy(4),ph*.22);
  X.fillStyle='#72b84a';rr(x1,y1,pw,gh,rad);X.fill();
  // grass blades
  for(let i=x1+wx(2);i<x1+pw-wx(1);i+=wx(2.5)){
    const bh=(4+Math.sin(i*1.1+tick*.03)*2)*H/WH;
    const lean=Math.sin(tick*.022+i*.5)*wx(1.2);
    X.strokeStyle=`rgba(${105+Math.random()*30|0},${175+Math.random()*30|0},${55+Math.random()*20|0},${.3+Math.random()*.2})`;
    X.lineWidth=wx(1.2);X.lineCap='round';
    X.beginPath();X.moveTo(i,y1);X.quadraticCurveTo(i+lean*.5,y1-bh*.6,i+lean,y1-bh);X.stroke();
  }
  // highlight
  X.fillStyle='rgba(255,255,255,.05)';rr(x1+wx(1),y1,pw-wx(2),wy(2),2);X.fill();
}

function drawPlaced(b){
  X.save();X.translate(wx(b.cx),wy(b.cy));X.rotate(b.a);
  const pw=wx(b.hw*2),ph=wy(b.hh*2);
  X.shadowColor='rgba(0,0,0,.18)';X.shadowBlur=wx(8);X.shadowOffsetY=wy(2);
  if(b.label.includes('plank')){
    const g=X.createLinearGradient(0,-ph/2,0,ph/2);
    g.addColorStop(0,'#dbb870');g.addColorStop(.5,'#c4a050');g.addColorStop(1,'#9a7a34');
    X.fillStyle=g;rr(-pw/2,-ph/2,pw,ph,wx(3));X.fill();
    X.strokeStyle='rgba(70,45,15,.1)';X.lineWidth=.7;
    for(let i=-pw/2+wx(6);i<pw/2;i+=wx(8)){X.beginPath();X.moveTo(i,-ph/2);X.lineTo(i,ph/2);X.stroke()}
    X.fillStyle='rgba(255,255,255,.08)';rr(-pw/2,-ph/2,pw,ph*.3,wx(3));X.fill();
  }else if(b.label.includes('box')){
    const g=X.createLinearGradient(-pw/2,-ph/2,pw/2,ph/2);
    g.addColorStop(0,'#c9a46a');g.addColorStop(1,'#8a6838');
    X.fillStyle=g;rr(-pw/2,-ph/2,pw,ph,wx(4));X.fill();
    X.strokeStyle='rgba(50,30,10,.08)';X.lineWidth=.7;
    X.beginPath();X.moveTo(-pw/2,-ph/2);X.lineTo(pw/2,ph/2);X.stroke();
    X.beginPath();X.moveTo(pw/2,-ph/2);X.lineTo(-pw/2,ph/2);X.stroke();
    X.strokeStyle='rgba(0,0,0,.08)';X.lineWidth=1.2;rr(-pw/2,-ph/2,pw,ph,wx(4));X.stroke();
  }else if(b.label.includes('trampoline')){
    X.fillStyle='#155580';rr(-pw/2,-ph/2,pw,ph,wx(3));X.fill();
    const tg=X.createLinearGradient(0,-ph/2,0,0);
    tg.addColorStop(0,'#4fc3f7');tg.addColorStop(1,'#1e88e5');
    X.fillStyle=tg;rr(-pw/2,-ph/2,pw,ph*.5,wx(3));X.fill();
    X.fillStyle='rgba(255,255,255,.12)';rr(-pw/2+wx(2),-ph/2,pw-wx(4),wy(1.5),1);X.fill();
    X.shadowColor='rgba(79,195,247,.2)';X.shadowBlur=wx(12);
    X.strokeStyle='rgba(79,195,247,.12)';X.lineWidth=1.5;rr(-pw/2,-ph/2,pw,ph,wx(3));X.stroke();
  }
  X.restore();
}

function drawHaz(){
  for(const hz of LV.haz){
    const hx=wx(hz.x),hy=wy(hz.y),hw=wx(hz.w),hh=wy(hz.h);
    if(hz.t==='water'){
      const wg=X.createLinearGradient(hx,hy,hx,hy+hh);
      wg.addColorStop(0,'rgba(30,136,229,.12)');wg.addColorStop(1,'rgba(13,71,161,.45)');
      X.fillStyle=wg;X.fillRect(hx,hy,hw,hh);
      for(let w=0;w<2;w++){
        X.strokeStyle=`rgba(120,200,255,${.18-.05*w})`;X.lineWidth=1;
        X.beginPath();for(let i=hx;i<=hx+hw;i+=wx(2))X.lineTo(i,hy+w*wy(3)+Math.sin(tick*(.05-.01*w)+i*(.08+.01*w))*wy(2));
        X.stroke();
      }
    }else if(hz.t==='spike'){
      const step=wx(7);
      for(let i=hx;i<hx+hw;i+=step){
        const g=X.createLinearGradient(i+step/2,hy,i+step/2,hy+hh);
        g.addColorStop(0,'#ddd');g.addColorStop(1,'#888');
        X.fillStyle=g;X.beginPath();X.moveTo(i,hy+hh);X.lineTo(i+step/2,hy);X.lineTo(i+step,hy+hh);X.fill();
      }
    }
  }
}

function drawGoal(){
  const gx=wx(LV.goal.x),gy=wy(LV.goal.y);
  const bob=Math.sin(tick*.04)*wy(4);
  const pulse=1+Math.sin(tick*.06)*.04;
  X.save();X.translate(gx,gy+bob);X.scale(pulse,pulse);
  // rays
  X.save();X.rotate(tick*.007);
  for(let i=0;i<8;i++){X.rotate(Math.PI/4);
    X.fillStyle=`rgba(255,213,79,${.012+Math.sin(tick*.03+i)*.008})`;
    X.beginPath();X.moveTo(-wx(1.5),- wy(10));X.lineTo(0,-wy(45));X.lineTo(wx(1.5),-wy(10));X.fill();}
  X.restore();
  // glow
  const og=X.createRadialGradient(0,-wy(4),1,0,-wy(4),wx(30));
  og.addColorStop(0,'rgba(255,213,79,.16)');og.addColorStop(1,'rgba(255,213,79,0)');
  X.fillStyle=og;X.beginPath();X.arc(0,-wy(4),wx(30),0,6.28);X.fill();
  // body
  X.shadowColor='rgba(255,200,50,.15)';X.shadowBlur=wx(10);
  const ng=X.createRadialGradient(-wx(3),-wy(6),1,0,-wy(3),wx(14));
  ng.addColorStop(0,'#fff3b0');ng.addColorStop(.3,'#ffe082');ng.addColorStop(.7,'#ffd54f');ng.addColorStop(1,'#f9a825');
  X.fillStyle=ng;X.beginPath();X.arc(0,-wy(3),wx(14),0,6.28);X.fill();
  // cap
  const cg=X.createLinearGradient(0,-wy(14),0,-wy(8));
  cg.addColorStop(0,'#6d4c14');cg.addColorStop(1,'#8d6e2f');
  X.fillStyle=cg;X.beginPath();X.ellipse(0,-wy(10.5),wx(10),wy(4),0,0,Math.PI,true);X.fill();
  X.fillStyle='#5a3d10';X.fillRect(-wx(1.2),-wy(15),wx(2.4),wy(5));
  // specular
  X.fillStyle='rgba(255,255,255,.35)';X.beginPath();X.ellipse(-wx(3),-wy(5.5),wx(3),wy(5),-.3,0,6.28);X.fill();
  X.restore();
}

/* ‚îÄ‚îÄ‚îÄ DRAW SQUIRREL (big, detailed) ‚îÄ‚îÄ‚îÄ */
function drawSq(sq){
  if(sq.saved)return;
  const sx=wx(sq.x),sy=wy(sq.y),r=wx(sq.r);
  if(!sq.alive){sq.dt--;if(sq.dt<=0)return;X.globalAlpha=sq.dt/70;X.beginPath();X.arc(sx,sy,r*.3,0,6.28);X.fillStyle='#999';X.fill();X.globalAlpha=1;return}
  if(!sq.on){const by=Math.sin(tick*.08+sq.spd*8)*wy(2);X.globalAlpha=.3;X.beginPath();X.arc(sx,sy+by,r*.4,0,6.28);X.fillStyle=sq.col;X.fill();X.globalAlpha=1;return}

  const br=1+Math.sin(sq.breathe)*.015;
  X.save();X.translate(sx,sy);X.scale(sq.dir,1);X.scale(br,1/br);

  const s=r/18; // unit scale relative to design radius

  // ‚îÄ‚îÄ SHADOW ‚îÄ‚îÄ
  const shg=X.createRadialGradient(0,r+s*2,0,0,r+s*2,r*.8);
  shg.addColorStop(0,'rgba(0,0,0,.1)');shg.addColorStop(1,'rgba(0,0,0,0)');
  X.fillStyle=shg;X.beginPath();X.ellipse(0,r+s*2,r*.8,s*3.5,0,0,6.28);X.fill();

  // ‚îÄ‚îÄ TAIL ‚îÄ‚îÄ
  const tw=Math.sin(sq.tail)*s*6;const tw2=Math.sin(sq.tail+.5)*s*3;
  X.beginPath();X.moveTo(-s*1.5,-r+s*3);
  X.bezierCurveTo(-r*1-tw,-r*1.3,-r*1.3-tw2,-r*2.2,-r*.35,-r*2.1);
  X.bezierCurveTo(-r*.05+tw*.2,-r*1.6,s*1.5,-r+s*4,s*1.5,-r+s*4);
  const tg=X.createLinearGradient(-r*1.2,-r*2.2,0,-r);
  tg.addColorStop(0,sq.colD);tg.addColorStop(.5,sq.col);tg.addColorStop(1,sq.colD);
  X.fillStyle=tg;X.fill();
  // tail highlight
  X.strokeStyle=sq.colL;X.globalAlpha=.12;X.lineWidth=s*1;
  X.beginPath();X.moveTo(-r*.3,-r*1.9);X.quadraticCurveTo(-r*.7-tw*.3,-r*1.5,0,-r+s*4);X.stroke();
  X.globalAlpha=1;

  // ‚îÄ‚îÄ BODY ‚îÄ‚îÄ
  X.beginPath();X.arc(0,0,r,0,6.28);
  const bg=X.createRadialGradient(-s*3,-s*4,0,0,0,r);
  bg.addColorStop(0,sq.colL);bg.addColorStop(.55,sq.col);bg.addColorStop(1,sq.colD);
  X.fillStyle=bg;X.fill();

  // ‚îÄ‚îÄ BELLY ‚îÄ‚îÄ
  X.beginPath();X.ellipse(s*1.5,s*3.5,r*.42,r*.38,.1,0,6.28);
  X.fillStyle=sq.belly;X.fill();

  // ‚îÄ‚îÄ EARS ‚îÄ‚îÄ
  const ew=Math.sin(sq.ear)*.07;
  [[-s*7,-r+s*1,-.22+ew],[s*7,-r+s*1,.22-ew]].forEach(([ex,ey,ea])=>{
    X.beginPath();X.ellipse(ex,ey-s*5.5,s*4,s*7.5,ea,0,6.28);
    const eg=X.createRadialGradient(ex,ey-s*5,0,ex,ey-s*5,s*7.5);
    eg.addColorStop(0,sq.col);eg.addColorStop(1,sq.colD);
    X.fillStyle=eg;X.fill();
    // inner
    X.beginPath();X.ellipse(ex,ey-s*5.5,s*2,s*4.5,ea,0,6.28);
    X.fillStyle=sq.earIn;X.fill();
  });

  // ‚îÄ‚îÄ EYES ‚îÄ‚îÄ
  const bl=sq.blink<5,sq2=sq.blink>=5&&sq.blink<8;
  [[-s*5,-s*2.5],[s*5,-s*2.5]].forEach(([ex,ey])=>{
    const eyH=bl?s*1:sq2?s*3:s*5.5;
    // white
    X.beginPath();X.ellipse(ex,ey,s*4,eyH,0,0,6.28);X.fillStyle='#fff';X.fill();
    // shadow
    X.beginPath();X.ellipse(ex,ey-eyH*.3,s*4,eyH*.35,0,0,6.28);X.fillStyle='rgba(0,0,0,.03)';X.fill();
    if(!bl&&!sq2){
      // iris
      X.beginPath();X.arc(ex+s*1.2,ey,s*2.5,0,6.28);X.fillStyle='#2d1b06';X.fill();
      // pupil
      X.beginPath();X.arc(ex+s*1.2,ey,s*1.5,0,6.28);X.fillStyle='#111';X.fill();
      // main highlight
      X.beginPath();X.arc(ex+s*2.2,ey-s*1.5,s*.9,0,6.28);X.fillStyle='rgba(255,255,255,.9)';X.fill();
      // second highlight
      X.beginPath();X.arc(ex-.3*s,ey+s*.8,s*.45,0,6.28);X.fillStyle='rgba(255,255,255,.35)';X.fill();
    }
  });

  // ‚îÄ‚îÄ NOSE ‚îÄ‚îÄ
  X.beginPath();X.ellipse(s*.8,s*2,s*2.2,s*1.6,0,0,6.28);
  const ng2=X.createRadialGradient(s*.4,s*1.5,0,s*.8,s*2,s*2.2);
  ng2.addColorStop(0,'#e55');ng2.addColorStop(1,'#b33');
  X.fillStyle=ng2;X.fill();
  X.fillStyle='rgba(255,255,255,.22)';X.beginPath();X.ellipse(s*.3,s*1.2,s*.7,s*.5,-.2,0,6.28);X.fill();

  // ‚îÄ‚îÄ WHISKERS ‚îÄ‚îÄ
  X.strokeStyle='rgba(255,255,255,.06)';X.lineWidth=s*.5;
  [[-1,-1],[1,-1]].forEach(([dx,dy])=>{
    for(let w=0;w<2;w++){X.beginPath();X.moveTo(dx*s*4.5,(s*2+dy+w*s*2));X.lineTo(dx*s*(9+w),(dy+w*s*2-s*1.5));X.stroke()}
  });

  // ‚îÄ‚îÄ CHEEKS ‚îÄ‚îÄ
  X.globalAlpha=.12;
  X.beginPath();X.arc(-s*7,s*3,s*3.5,0,6.28);X.fillStyle='#ffab91';X.fill();
  X.beginPath();X.arc(s*7,s*3,s*3.5,0,6.28);X.fill();
  X.globalAlpha=1;

  // ‚îÄ‚îÄ MOUTH ‚îÄ‚îÄ
  X.strokeStyle='rgba(80,40,20,.1)';X.lineWidth=s*.7;
  X.beginPath();X.arc(s*.8,s*3.8,s*2.5,.15,Math.PI-.15);X.stroke();

  // ‚îÄ‚îÄ FEET ‚îÄ‚îÄ
  if(sq.ground){
    const fw=Math.sin(sq.runFrame)*s*2.5;
    X.fillStyle=sq.colD;
    [[-s*4+fw,r],[s*4-fw,r]].forEach(([fx,fy])=>{
      X.beginPath();X.ellipse(fx,fy+s*1,s*4,s*2.2,0,0,6.28);X.fill();
    });
  }else{
    // in-air legs
    X.fillStyle=sq.colD;
    X.beginPath();X.ellipse(-s*3,r-s*1,s*3,s*2,.15,0,6.28);X.fill();
    X.beginPath();X.ellipse(s*3,r-s*1,s*3,s*2,-.15,0,6.28);X.fill();
  }

  // ‚îÄ‚îÄ ARMS ‚îÄ‚îÄ
  if(!sq.ground){
    X.fillStyle=sq.col;
    X.beginPath();X.ellipse(-r+s*2,-s*1,s*3,s*2,.4,0,6.28);X.fill();
    X.beginPath();X.ellipse(r-s*2,-s*1,s*3,s*2,-.4,0,6.28);X.fill();
  }

  // ‚îÄ‚îÄ RIM LIGHT ‚îÄ‚îÄ
  X.globalAlpha=.05;X.beginPath();X.arc(0,0,r,-.6,1.9);
  X.strokeStyle='#fff';X.lineWidth=s*1.5;X.stroke();
  X.globalAlpha=1;

  X.restore();
}

/* ‚îÄ‚îÄ‚îÄ GHOST ITEMS (plan phase) ‚îÄ‚îÄ‚îÄ */
function drawGhosts(){
  G.placed.forEach(it=>{
    const d=ITEMS[it.type];X.save();X.translate(wx(it.x),wy(it.y));X.rotate(it.a);
    const pw=wx(d.w),ph=wy(d.h);
    X.globalAlpha=.5;X.fillStyle=d.bouncy?'#1e88e5':'#c49a52';rr(-pw/2,-ph/2,pw,ph,wx(3));X.fill();
    X.globalAlpha=.7;X.fillStyle='#fff';X.font=`bold ${wx(10)}px sans-serif`;X.textAlign='center';X.textBaseline='middle';
    X.fillText('‚úï',0,0);X.globalAlpha=1;X.restore();
  });
}

let mX=0,mY=0;
function drawCursor(){
  if(!G.sel||G.ph!=='plan')return;
  const d=ITEMS[G.sel],pw=wx(d.w),ph=wy(d.h);
  X.save();X.translate(mX,mY);X.rotate(G.ga);X.globalAlpha=.28;
  X.fillStyle=d.bouncy?'#1e88e5':'#c49a52';rr(-pw/2,-ph/2,pw,ph,wx(3));X.fill();
  X.globalAlpha=1;X.restore();
}

function drawParts(){
  parts=parts.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.1;p.life--;if(p.life<=0)return false;
    const a=p.life/p.ml;X.globalAlpha=a;X.beginPath();X.arc(wx(p.x),wy(p.y),p.r*W/WW*a,0,6.28);
    X.fillStyle=p.col;X.fill();X.globalAlpha=1;return true;});
}

/* ‚îÄ‚îÄ‚îÄ PLACEMENT ‚îÄ‚îÄ‚îÄ */
function place(ww,wh){if(!G.sel||G.ph!=='plan'||(G.tb[G.sel]||0)<=0)return;if(ww<5||ww>WW-5||wh<5||wh>WH-20)return;
  G.placed.push({type:G.sel,x:ww,y:wh,a:G.ga});G.tb[G.sel]--;if(G.tb[G.sel]<=0)G.sel=null;buildTB()}
function removeI(i){if(G.ph!=='plan')return;G.tb[G.placed[i].type]=(G.tb[G.placed[i].type]||0)+1;G.placed.splice(i,1);buildTB()}
function findAt(ww,wh){for(let i=G.placed.length-1;i>=0;i--){const it=G.placed[i],d=ITEMS[it.type];const dx=ww-it.x,dy=wh-it.y,c=Math.cos(-it.a),sn=Math.sin(-it.a);if(Math.abs(dx*c-dy*sn)<d.w/2+10&&Math.abs(dx*sn+dy*c)<d.h/2+10)return i}return-1}

/* ‚îÄ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ‚îÄ */
C.addEventListener('pointerdown',e=>{e.preventDefault();const r=C.getBoundingClientRect(),sx=e.clientX-r.left,sy=e.clientY-r.top;mX=sx;mY=sy;
  if(G.ph==='plan'){const wp=s2w(sx,sy);const idx=findAt(wp.x,wp.y);if(idx>=0){removeI(idx);return}if(G.sel)place(wp.x,wp.y)}});
C.addEventListener('pointermove',e=>{const r=C.getBoundingClientRect();mX=e.clientX-r.left;mY=e.clientY-r.top});
document.addEventListener('keydown',e=>{if(e.code==='KeyQ')G.ga-=Math.PI/12;if(e.code==='KeyE')G.ga+=Math.PI/12});

/* ‚îÄ‚îÄ‚îÄ UI ‚îÄ‚îÄ‚îÄ */
function showTut(t){$('tut').textContent=t;$('tut').style.display='block'}
function hideTut(){$('tut').style.display='none'}
function mk(t,c){const e=document.createElement(t);e.className=c;return e}
function updHUD(){const al=sqs.filter(s=>s.alive&&!s.saved).length;
  $('ha').textContent=al;$('hs').textContent=G.saved;$('hn').textContent=LV.need;
  const t=Math.max(0,Math.ceil(G.pt));$('ht').textContent=t;
  const pct=G.ph==='plan'?G.pt/LV.time*100:0;const bar=$('tbf');bar.style.width=pct+'%';
  bar.style.background=pct>40?'linear-gradient(90deg,#66bb6a,#a5d6a7)':pct>15?'linear-gradient(90deg,#ffd54f,#ffb300)':'linear-gradient(90deg,#ef5350,#ff8a65)'}

function buildTB(){const row=$('tbi');row.innerHTML='';
  if(G.ph==='plan'){
    let rl=mk('button','tb');rl.innerHTML='<em>‚Ü∫</em>';rl.onclick=()=>{G.ga-=Math.PI/8};row.appendChild(rl);
    for(let k in G.tb){const d=ITEMS[k],cnt=G.tb[k];let btn=mk('button','tb'+(G.sel===k?' sel':'')+(cnt<=0?' dis':''));
      btn.innerHTML=`<em>${d.ic}</em><small>${d.n} √ó${cnt}</small>`;const key=k;
      btn.onclick=()=>{G.sel=G.sel===key?null:key;G.ga=0;buildTB()};row.appendChild(btn)}
    let rr2=mk('button','tb');rr2.innerHTML='<em>‚Üª</em>';rr2.onclick=()=>{G.ga+=Math.PI/8};row.appendChild(rr2);
    let go=mk('button','tb');go.id='go';go.innerHTML='<em>‚ñ∂</em>–ü–£–°–ö';go.onclick=()=>run();row.appendChild(go);
  }else if(G.ph==='run'){const info=mk('div','');info.style.cssText='color:rgba(255,255,255,.3);font-size:12px;padding:12px;font-weight:600';info.textContent='üêøÔ∏è –ë–µ–ª–∫–∏ –±–µ–≥—É—Ç –∫ –æ—Ä–µ—Ö—É‚Ä¶';row.appendChild(info)}
  $('toolbar').style.display='block'}

function doWin(){G.ph='win';const r=G.saved/LV.sq;const st=r>=.85?3:r>=.55?2:1;
  $('ws').textContent='‚≠ê'.repeat(st)+'‚òÜ'.repeat(3-st);$('wt').textContent=`–°–ø–∞—Å–µ–Ω–æ: ${G.saved} –∏–∑ ${LV.sq}`;
  $('toolbar').style.display='none';$('sw').style.display='flex';$('sw').classList.remove('h')}
function doLose(){G.ph='lose';$('lt').textContent=`–°–ø–∞—Å–µ–Ω–æ ${G.saved} –∏–∑ ${LV.need} –Ω—É–∂–Ω—ã—Ö`;
  $('toolbar').style.display='none';$('sl').style.display='flex';$('sl').classList.remove('h')}

$('b1').addEventListener('click',init);
$('b2').addEventListener('click',init);
$('b3').addEventListener('click',init);

/* ‚îÄ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ‚îÄ */
let lt=0;
function loop(ts){const dt=Math.min(ts-lt,50);lt=ts;X.clearRect(0,0,W,H);
  if(G.ph==='plan'||G.ph==='run'){
    drawBg();drawHaz();
    for(const b of bodies){if(b.label==='plat')drawPlat(b);else if(b.label.startsWith('p_'))drawPlaced(b)}
    if(G.ph==='plan')drawGhosts();drawGoal();sqs.forEach(drawSq);drawParts();
    if(G.ph==='plan')drawCursor();
    if(G.ph==='run'){physTick();physTick()}
    if(G.ph==='plan'){G.pt-=dt/1000;if(G.pt<=0){G.pt=0;run()}}
    tick++;updHUD();
  }else{
    const sg=X.createLinearGradient(0,0,0,H);sg.addColorStop(0,'#030a05');sg.addColorStop(.5,'#0e2816');sg.addColorStop(1,'#081810');
    X.fillStyle=sg;X.fillRect(0,0,W,H);
    fireflies.forEach(f=>{f.x+=f.vx+Math.sin(tick*.018+f.p)*.1;f.y+=f.vy+Math.cos(tick*.013+f.p)*.08;
      if(f.x<0)f.x=WW;if(f.x>WW)f.x=0;if(f.y<WH*.2)f.y=WH*.7;if(f.y>WH*.85)f.y=WH*.3;
      const gl=.12+.45*(.5+.5*Math.sin(tick*.035+f.p));
      X.beginPath();X.arc(wx(f.x),wy(f.y),f.r*W/WW,0,6.28);X.fillStyle=`rgba(180,255,100,${gl})`;X.fill();
      X.beginPath();X.arc(wx(f.x),wy(f.y),f.r*5*W/WW,0,6.28);X.fillStyle=`rgba(180,255,100,${gl*.04})`;X.fill();});
    tick=(tick||0)+1;
  }
  requestAnimationFrame(loop)}
requestAnimationFrame(loop);
</script>
</body>
</html>
